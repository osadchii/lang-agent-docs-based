# ÐœÐ¾Ð½ÐµÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

## ÐžÐ±Ñ‰Ð°Ñ ÐºÐ¾Ð½Ñ†ÐµÐ¿Ñ†Ð¸Ñ

Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð½Ð° Ð¼Ð¾Ð´ÐµÐ»Ð¸ freemium Ñ Ð´Ð²ÑƒÐ¼Ñ Ñ‚Ð°Ñ€Ð¸Ñ„Ð°Ð¼Ð¸:
- **Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½** - Ð±Ð°Ð·Ð¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸
- **ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð»Ð°Ð½** - Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹

Ð’ÑÐµ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ **7-Ð´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´** Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼-Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼ Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ ÐºÐ°Ñ€Ñ‚Ñ‹.

---

## ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

### Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ‚Ð°Ñ€Ð¸Ñ„ (Free Tier)

**ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ:**

| Ð ÐµÑÑƒÑ€Ñ | Ð›Ð¸Ð¼Ð¸Ñ‚ |
|--------|-------|
| Ð¯Ð·Ñ‹ÐºÐ¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ | 1 Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ |
| LLM ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ | 50 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ |
| Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ | 10 ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ |
| ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ | 200 ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ |
| Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ | 1 Ð³Ñ€ÑƒÐ¿Ð¿Ð° (Ð¿Ð¾ 5 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²) |

**Ð§Ñ‚Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾:**
- ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ñ Ð˜Ð˜-Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ (Ð² Ñ€Ð°Ð¼ÐºÐ°Ñ… Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²)
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº
- Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹
- Ð£Ñ‡Ð°ÑÑ‚Ð¸Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
- Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ ÑÑ‚Ñ€Ð¸ÐºÐ¸
- Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸ (OCR)
- Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ

**Ð§Ñ‚Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾:**
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐ·Ñ‹ÐºÐ¾Ð²Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹
- ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
- ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ð³Ñ€ÑƒÐ¿Ð¿
- Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ…

### ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° (Premium Tier)

**Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹:**

| Ð ÐµÑÑƒÑ€Ñ | Ð›Ð¸Ð¼Ð¸Ñ‚ |
|--------|-------|
| Ð¯Ð·Ñ‹ÐºÐ¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ | Ð‘ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ (Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð¾ 10) |
| LLM ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ | 500 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ |
| Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ | Ð‘ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ |
| ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ | Ð‘ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ |
| Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ | Ð‘ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ (Ð¿Ð¾ 100 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²) |

**Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:**
- Ð˜Ð·ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÑÐ·Ñ‹ÐºÐ¾Ð² Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ (Ð´Ð¾ 10 Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹)
- ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
- Ð Ð°Ð½Ð½Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð¾Ð²Ñ‹Ð¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿ Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
- Ð”Ð¾ 100 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ð² ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð³Ñ€ÑƒÐ¿Ð¿Ðµ (vs 5 Ð´Ð»Ñ free)

**Ð¢Ð°Ñ€Ð¸Ñ„Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð½Ñ‹:**

```
ÐœÐµÑÑÑ‡Ð½Ð°Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°: â‚¬4.99/Ð¼ÐµÑÑÑ†
Ð“Ð¾Ð´Ð¾Ð²Ð°Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°:  â‚¬49/Ð³Ð¾Ð´ (ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ ~17%, â‚¬4.08/Ð¼ÐµÑÑÑ†)
```

**ÐÐ²Ñ‚Ð¾Ð¿Ñ€Ð¾Ð´Ð»ÐµÐ½Ð¸Ðµ:**
- ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Stripe
- ÐœÐ¾Ð¶Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð² Ð»ÑŽÐ±Ð¾Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ñ‡ÐµÑ€ÐµÐ· Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð»Ð¸ Ð¿Ð°Ð½ÐµÐ»ÑŒ Stripe
- ÐŸÑ€Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°

---

## Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼Ð°

### Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹

#### LLM ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
- **Free:** 50 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ
- **Premium:** 500 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ
- **ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ðº:**
  - Ð”Ð¸Ð°Ð»Ð¾Ð³Ð°Ð¼ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
  - Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº Ñ‡ÐµÑ€ÐµÐ· LLM
  - Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹
  - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
  - OCR Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸

#### ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸
- **Free:** Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 200 ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº
- **Premium:** Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
- **ÐŸÑ€Ð¸ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¸Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð° (free):**
  - Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
  - ÐÐµÐ»ÑŒÐ·Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ
  - ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ñ‚ÑŒ Ð¸Ð·ÑƒÑ‡Ð°Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ

#### Ð¯Ð·Ñ‹ÐºÐ¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸
- **Free:** 1 Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ (Ð¾Ð´Ð¸Ð½ ÑÐ·Ñ‹Ðº)
- **Premium:** Ð´Ð¾ 10 Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ (Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐ·Ñ‹ÐºÐ¾Ð² Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾)
- **ÐŸÑ€Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ðµ Ñ premium Ð½Ð° free:**
  - Ð’ÑÐµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ
  - ÐœÐ¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ð¼ÐµÐ¶Ð´Ñƒ Ð½Ð¸Ð¼Ð¸
  - ÐÐµÐ»ÑŒÐ·Ñ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð´Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð»Ð¸ÑˆÐ½Ð¸Ñ…

#### Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸ ÐºÐ¾Ð»Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ†Ð¸Ñ
- **Free:**
  - 1 Ð³Ñ€ÑƒÐ¿Ð¿Ð°-Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
  - 5 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
  - ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
- **Premium:**
  - ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿-Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†ÐµÐ²
  - 100 ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
  - ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ…

#### Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ
- **Free:** 10 ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ
- **Premium:** Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
- Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ð² Ð¾Ð±Ñ‰ÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚Ðµ LLM ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹

### Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

#### ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
- ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ñ‚ÐµÑ…Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ
- ÐŸÑ€ÑÐ¼Ð¾Ð¹ ÐºÐ°Ð½Ð°Ð» ÑÐ²ÑÐ·Ð¸ Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
- Ð‘Ð¾Ð»ÐµÐµ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚ÐºÐ»Ð¸ÐºÐ° Ð½Ð° Ð±Ð°Ð³Ð¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ

#### Ð Ð°Ð½Ð½Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
- Beta-Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
- Ð’Ð»Ð¸ÑÐ½Ð¸Ðµ Ð½Ð° Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð° Ñ‡ÐµÑ€ÐµÐ· Ð¾Ð¿Ñ€Ð¾ÑÑ‹
- Ð­ÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑÐ¼

#### Ð‘ÑƒÐ´ÑƒÑ‰Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ (Ð² Ð¿Ð»Ð°Ð½Ð°Ñ… Ð´Ð»Ñ v2.0)
- ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ñ‚ÐµÐ¼ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ AI-Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
- Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð² Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°Ñ…
- Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¼Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼Ð¸ (Anki, Quizlet)
- ÐžÑ„Ð»Ð°Ð¹Ð½-Ñ€ÐµÐ¶Ð¸Ð¼ Ð² Mini App

### ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°

**Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° (Free + Premium):**
- Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ñ€Ð¸Ðº
- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº/ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹
- ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸
- ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¿Ð¾ Ñ‚ÐµÐ¼Ð°Ð¼

**Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ (Premium, Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ v2.0):**
- Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ
- ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð·Ñ‹ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ
- Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ (Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ð¾)
- Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ
- Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð² CSV/JSON

---

## ÐŸÑ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´ (Trial)

### ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ñ‚Ñ€Ð¸Ð°Ð»Ð°

**Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:** 7 Ð´Ð½ÐµÐ¹

**Ð”Ð¾ÑÑ‚ÑƒÐ¿:**
- ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼-Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»
- Ð’ÑÐµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼-Ð¿Ð»Ð°Ð½Ð°

**Ð£ÑÐ»Ð¾Ð²Ð¸Ñ:**
- ÐÐµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ° ÐºÐ°Ñ€Ñ‚Ñ‹
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
- Ð”Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
- ÐÐµÐ»ÑŒÐ·Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ

**ÐžÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ðµ Ñ‚Ñ€Ð¸Ð°Ð»Ð°:**
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½
- Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ
- ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ free tier
- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð·Ð° 1 Ð´ÐµÐ½ÑŒ Ð´Ð¾ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ

### ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ñ€Ð¸Ð°Ð»Ð°

**ÐŸÐ¾Ð»Ñ Ð² Ð‘Ð”:**

```sql
-- users table
trial_ends_at TIMESTAMP          -- Ð”Ð°Ñ‚Ð° Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ñ‚Ñ€Ð¸Ð°Ð»Ð°
trial_used BOOLEAN DEFAULT FALSE -- Ð£Ð¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð» Ñ‚Ñ€Ð¸Ð°Ð»
```

**Ð›Ð¾Ð³Ð¸ÐºÐ°:**

```python
def check_trial_status(user: User) -> dict:
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑ Ñ‚Ñ€Ð¸Ð°Ð»Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.
    """
    now = datetime.utcnow()

    # Ð¢Ñ€Ð¸Ð°Ð» Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½
    if user.trial_ends_at and user.trial_ends_at > now:
        return {
            'status': 'trial',
            'active': True,
            'expires_at': user.trial_ends_at,
            'days_remaining': (user.trial_ends_at - now).days
        }

    # Ð¢Ñ€Ð¸Ð°Ð» Ð¸ÑÑ‚ÐµÐº
    if user.trial_used:
        return {
            'status': 'trial',
            'active': False,
            'expired': True
        }

    # Ð¢Ñ€Ð¸Ð°Ð» Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ (Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ)
    return {
        'status': 'trial',
        'active': False,
        'available': True
    }
```

---

## ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Stripe

#### Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹

**ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€:** Stripe

**ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°:**
- ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´ÑƒÐ½Ð°Ñ€Ð¾Ð´Ð½Ñ‹Ñ… ÐºÐ°Ñ€Ñ‚
- PCI DSS compliance Ð¸Ð· ÐºÐ¾Ñ€Ð¾Ð±ÐºÐ¸
- Webhooks Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
- Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ UI ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (Stripe Checkout)
- Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°Ð¼Ð¸ Ð¸ recurring payments
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° failed payments

#### ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹

**1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Checkout Session**

```python
@app.post('/api/subscriptions/create-checkout')
def create_checkout_session(
    request: CreateCheckoutRequest,
    current_user: User = Depends(get_current_user)
):
    """
    Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ Stripe Checkout Session Ð´Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸.
    """
    import stripe
    stripe.api_key = settings.STRIPE_SECRET_KEY

    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Price ID Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¿Ð»Ð°Ð½Ð°
    price_id = {
        'monthly': settings.STRIPE_PRICE_MONTHLY,
        'yearly': settings.STRIPE_PRICE_YEARLY
    }[request.plan]

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Stripe Customer
    if not current_user.subscription or not current_user.subscription.stripe_customer_id:
        customer = stripe.Customer.create(
            email=current_user.email if current_user.email else None,
            metadata={
                'user_id': str(current_user.id),
                'telegram_id': current_user.telegram_id
            }
        )
        customer_id = customer.id
    else:
        customer_id = current_user.subscription.stripe_customer_id

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Checkout Session
    checkout_session = stripe.checkout.Session.create(
        customer=customer_id,
        payment_method_types=['card'],
        line_items=[{
            'price': price_id,
            'quantity': 1,
        }],
        mode='subscription',
        success_url=request.success_url,
        cancel_url=request.cancel_url,
        metadata={
            'user_id': str(current_user.id)
        }
    )

    return {
        'checkout_session_id': checkout_session.id,
        'checkout_url': checkout_session.url
    }
```

**Request:**
```json
{
  "plan": "yearly",
  "success_url": "https://t.me/bot?start=payment_success",
  "cancel_url": "https://t.me/bot?start=payment_cancel"
}
```

**Response:**
```json
{
  "checkout_session_id": "cs_xxx",
  "checkout_url": "https://checkout.stripe.com/c/pay/cs_xxx"
}
```

**2. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚**

- Frontend Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ `checkout_url`
- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ñ€Ñ‚Ñ‹
- Stripe Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð»Ð°Ñ‚ÐµÐ¶
- Redirect Ð½Ð° `success_url` Ð¸Ð»Ð¸ `cancel_url`

**3. Stripe Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Webhook**

Stripe Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ `checkout.session.completed` Ð½Ð° Ð½Ð°Ñˆ webhook endpoint.

#### ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Webhooks

**Endpoint:**

```python
@app.post('/api/subscriptions/webhook')
async def stripe_webhook(request: Request):
    """
    ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ webhooks Ð¾Ñ‚ Stripe.
    Ð’ÐÐ–ÐÐž: Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ HTTPS Ð´Ð»Ñ production!
    """
    import stripe

    payload = await request.body()
    sig_header = request.headers.get('Stripe-Signature')

    try:
        # Ð’ÐµÑ€Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid payload")
    except stripe.error.SignatureVerificationError:
        raise HTTPException(status_code=400, detail="Invalid signature")

    # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
    event_type = event['type']
    event_data = event['data']['object']

    if event_type == 'checkout.session.completed':
        handle_checkout_completed(event_data)

    elif event_type == 'invoice.paid':
        handle_invoice_paid(event_data)

    elif event_type == 'invoice.payment_failed':
        handle_payment_failed(event_data)

    elif event_type == 'customer.subscription.updated':
        handle_subscription_updated(event_data)

    elif event_type == 'customer.subscription.deleted':
        handle_subscription_deleted(event_data)

    return {'received': True}
```

**ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹:**

```python
def handle_checkout_completed(session: dict):
    """
    ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹.
    """
    user_id = session['metadata']['user_id']
    customer_id = session['customer']
    subscription_id = session['subscription']

    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¸Ð· Stripe
    import stripe
    subscription = stripe.Subscription.retrieve(subscription_id)

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð² Ð‘Ð”
    user = db.query(User).filter(User.id == user_id).first()

    if not user.subscription:
        user.subscription = Subscription(user_id=user_id)

    user.subscription.stripe_customer_id = customer_id
    user.subscription.stripe_subscription_id = subscription_id
    user.subscription.status = 'active'
    user.subscription.plan = 'monthly' if subscription.items.data[0].price.recurring.interval == 'month' else 'yearly'
    user.subscription.price = subscription.items.data[0].price.unit_amount / 100  # Cents to euros
    user.subscription.currency = subscription.items.data[0].price.currency.upper()
    user.subscription.current_period_start = datetime.fromtimestamp(subscription.current_period_start)
    user.subscription.current_period_end = datetime.fromtimestamp(subscription.current_period_end)

    # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
    user.is_premium = True
    user.premium_expires_at = user.subscription.current_period_end

    db.commit()

    # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    send_notification(user, 'subscription_activated')

    logger.info(f"Subscription activated: user_id={user_id}, subscription_id={subscription_id}")


def handle_subscription_updated(subscription: dict):
    """
    ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ….
    """
    subscription_id = subscription['id']

    db_subscription = db.query(Subscription).filter(
        Subscription.stripe_subscription_id == subscription_id
    ).first()

    if not db_subscription:
        logger.warning(f"Subscription not found: {subscription_id}")
        return

    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
    db_subscription.status = subscription['status']  # active, canceled, past_due, etc.
    db_subscription.cancel_at_period_end = subscription['cancel_at_period_end']
    db_subscription.current_period_end = datetime.fromtimestamp(subscription['current_period_end'])

    # Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°
    if subscription['cancel_at_period_end']:
        db_subscription.canceled_at = datetime.fromtimestamp(subscription['canceled_at'])

    db.commit()

    logger.info(f"Subscription updated: {subscription_id}, status={subscription['status']}")


def handle_subscription_deleted(subscription: dict):
    """
    ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ/Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸.
    """
    subscription_id = subscription['id']

    db_subscription = db.query(Subscription).filter(
        Subscription.stripe_subscription_id == subscription_id
    ).first()

    if not db_subscription:
        return

    # ÐœÐµÐ½ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
    db_subscription.status = 'expired'

    # Ð”ÐµÐ°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼
    user = db_subscription.user
    user.is_premium = False
    user.premium_expires_at = None

    db.commit()

    # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    send_notification(user, 'subscription_expired')

    logger.info(f"Subscription deleted: user_id={user.id}")
```

**Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ Stripe:**

| Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ | ÐšÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ | Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ |
|---------|------------------|----------|
| `checkout.session.completed` | Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· Checkout | ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ |
| `invoice.paid` | Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ (renewal) | ÐŸÑ€Ð¾Ð´Ð»ÐµÐ²Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ |
| `invoice.payment_failed` | ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð° | Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ Ð² past_due |
| `customer.subscription.updated` | Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ | ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð‘Ð” |
| `customer.subscription.deleted` | Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ | Ð”ÐµÐ°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ |

#### Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¾Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼

**ÐžÑ‚Ð¼ÐµÐ½Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:**

```python
@app.post('/api/subscriptions/cancel')
def cancel_subscription(current_user: User = Depends(get_current_user)):
    """
    ÐžÑ‚Ð¼ÐµÐ½ÑÐµÑ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ (Ð°Ð²Ñ‚Ð¾Ð¿Ñ€Ð¾Ð´Ð»ÐµÐ½Ð¸Ðµ).
    ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°.
    """
    if not current_user.subscription or current_user.subscription.status != 'active':
        raise HTTPException(status_code=400, detail="No active subscription")

    import stripe
    stripe.api_key = settings.STRIPE_SECRET_KEY

    # ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð² Stripe
    subscription = stripe.Subscription.modify(
        current_user.subscription.stripe_subscription_id,
        cancel_at_period_end=True
    )

    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð² Ð‘Ð”
    current_user.subscription.cancel_at_period_end = True
    current_user.subscription.canceled_at = datetime.utcnow()
    db.commit()

    return {
        'status': 'active',
        'cancel_at_period_end': True,
        'current_period_end': current_user.subscription.current_period_end,
        'message': f"ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð° {current_user.subscription.current_period_end.strftime('%d.%m.%Y')}"
    }
```

**Ð’Ð¾Ð·Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:**

```python
@app.post('/api/subscriptions/reactivate')
def reactivate_subscription(current_user: User = Depends(get_current_user)):
    """
    Ð’Ð¾Ð·Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ (Ð¾Ñ‚Ð¼ÐµÐ½ÑÐµÑ‚ cancel_at_period_end).
    """
    if not current_user.subscription or not current_user.subscription.cancel_at_period_end:
        raise HTTPException(status_code=400, detail="Subscription not canceled")

    import stripe
    stripe.api_key = settings.STRIPE_SECRET_KEY

    # Ð’Ð¾Ð·Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð² Stripe
    subscription = stripe.Subscription.modify(
        current_user.subscription.stripe_subscription_id,
        cancel_at_period_end=False
    )

    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð² Ð‘Ð”
    current_user.subscription.cancel_at_period_end = False
    current_user.subscription.canceled_at = None
    db.commit()

    return {
        'status': 'active',
        'cancel_at_period_end': False,
        'message': 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° Ð²Ð¾Ð·Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°'
    }
```

### Ð ÑƒÑ‡Ð½Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ:
- ÐŸÑ€Ð¾Ð¼Ð¾-Ð°ÐºÑ†Ð¸Ð¹
- ÐšÐ¾Ð¼Ð¿ÐµÐ½ÑÐ°Ñ†Ð¸Ð¹ Ð·Ð° Ð±Ð°Ð³Ð¸
- Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
- Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

**Endpoint:**

```python
@app.post('/api/admin/users/{user_id}/premium')
def manually_activate_premium(
    user_id: UUID,
    request: ManualPremiumRequest,
    current_admin: User = Depends(require_admin)
):
    """
    Ð’Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.
    Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð².
    """
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")

    # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼
    user.is_premium = True

    if request.duration_days == "unlimited":
        user.premium_expires_at = None  # Ð‘ÐµÑÑÑ€Ð¾Ñ‡Ð½Ð¾
    else:
        user.premium_expires_at = datetime.utcnow() + timedelta(days=request.duration_days)

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
    if not user.subscription:
        user.subscription = Subscription(user_id=user_id)

    user.subscription.status = 'active'
    user.subscription.plan = None  # Ð ÑƒÑ‡Ð½Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ

    db.commit()

    # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
    log_admin_action(
        admin_id=current_admin.id,
        action='manual_premium_activation',
        target_user_id=user_id,
        details={
            'duration_days': request.duration_days,
            'reason': request.reason
        }
    )

    # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    send_notification(user, 'premium_activated_manually', {
        'duration': request.duration_days,
        'reason': request.reason
    })

    return {
        'user_id': str(user_id),
        'is_premium': True,
        'expires_at': user.premium_expires_at.isoformat() if user.premium_expires_at else None,
        'reason': request.reason
    }
```

**Request:**
```json
{
  "duration_days": 30,
  "reason": "Compensation for bug #145"
}
```

Ð¸Ð»Ð¸

```json
{
  "duration_days": "unlimited",
  "reason": "Team member"
}
```

**Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:**

Ð’ÑÐµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð»Ð¾Ð³Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð´Ð»Ñ Ð°ÑƒÐ´Ð¸Ñ‚Ð°:

```python
class AdminActionLog(Base):
    __tablename__ = 'admin_action_logs'

    id = Column(UUID, primary_key=True, default=uuid4)
    admin_id = Column(UUID, ForeignKey('users.id'), nullable=False)
    action = Column(String, nullable=False)  # 'manual_premium_activation', etc.
    target_user_id = Column(UUID, ForeignKey('users.id'))
    details = Column(JSONB)  # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
    timestamp = Column(DateTime, default=datetime.utcnow)
```

---

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

### ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²:**

```python
def get_user_limits(user: User) -> dict:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸.
    """
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼
    is_premium = user.is_premium

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ñ€Ð¸Ð°Ð»
    if user.trial_ends_at and user.trial_ends_at > datetime.utcnow():
        is_premium = True

    # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹
    if is_premium:
        limits = {
            'profiles': {'max': 10},
            'messages': {'max': 500, 'reset_interval': 'daily'},
            'exercises': {'max': None},  # Unlimited
            'cards': {'max': None},      # Unlimited
            'groups': {'max': None, 'members_per_group': 100}
        }
    else:
        limits = {
            'profiles': {'max': 1},
            'messages': {'max': 50, 'reset_interval': 'daily'},
            'exercises': {'max': 10, 'reset_interval': 'daily'},
            'cards': {'max': 200},
            'groups': {'max': 1, 'members_per_group': 5}
        }

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ
    limits['profiles']['used'] = db.query(LanguageProfile).filter(
        LanguageProfile.user_id == user.id,
        LanguageProfile.deleted == False
    ).count()

    limits['cards']['used'] = db.query(Card).join(Deck).filter(
        Deck.user_id == user.id,
        Card.deleted == False
    ).count()

    # Ð”Ð½ÐµÐ²Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ (Ð¸Ð· Redis)
    limits['messages']['used'] = get_daily_usage(user.id, 'messages')
    limits['messages']['reset_at'] = get_next_reset_time()

    if limits['exercises']['max'] is not None:
        limits['exercises']['used'] = get_daily_usage(user.id, 'exercises')
        limits['exercises']['reset_at'] = get_next_reset_time()

    limits['groups']['used'] = db.query(Group).filter(
        Group.owner_id == user.id,
        Group.deleted == False
    ).count()

    return limits


def get_daily_usage(user_id: UUID, resource_type: str) -> int:
    """
    ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð´Ð½ÐµÐ²Ð½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð· Redis.
    """
    key = f"daily_usage:{resource_type}:{user_id}:{datetime.utcnow().date()}"
    usage = redis_client.get(key)
    return int(usage) if usage else 0


def increment_daily_usage(user_id: UUID, resource_type: str):
    """
    Ð˜Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ.
    """
    key = f"daily_usage:{resource_type}:{user_id}:{datetime.utcnow().date()}"

    if not redis_client.exists(key):
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ TTL Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð´Ð½Ñ
        midnight = datetime.combine(datetime.utcnow().date() + timedelta(days=1), datetime.min.time())
        ttl = int((midnight - datetime.utcnow()).total_seconds())
        redis_client.setex(key, ttl, 1)
    else:
        redis_client.incr(key)


def get_next_reset_time() -> str:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð²Ñ€ÐµÐ¼Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑÐ±Ñ€Ð¾ÑÐ° (Ð¿Ð¾Ð»Ð½Ð¾Ñ‡ÑŒ UTC).
    """
    tomorrow = datetime.utcnow().date() + timedelta(days=1)
    midnight = datetime.combine(tomorrow, datetime.min.time())
    return midnight.isoformat()
```

### Middleware Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²

**Ð”ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸:**

```python
def require_limit(resource_type: str):
    """
    Ð”ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ.
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, current_user: User, **kwargs):
            limits = get_user_limits(current_user)

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚
            resource_limits = limits.get(resource_type)
            if not resource_limits:
                return await func(*args, current_user=current_user, **kwargs)

            max_limit = resource_limits.get('max')
            current_usage = resource_limits.get('used', 0)

            # Unlimited
            if max_limit is None:
                return await func(*args, current_user=current_user, **kwargs)

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¸Ðµ
            if current_usage >= max_limit:
                raise HTTPException(
                    status_code=400 if current_user.is_premium else 402,
                    detail={
                        'code': 'LIMIT_REACHED',
                        'message': f"Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ {resource_type} ({max_limit})",
                        'details': {
                            'limit_type': resource_type,
                            'current': current_usage,
                            'max': max_limit,
                            'reset_at': resource_limits.get('reset_at'),
                            'upgrade_url': '/profile/premium' if not current_user.is_premium else None
                        }
                    }
                )

            # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ
            result = await func(*args, current_user=current_user, **kwargs)

            # Ð˜Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº (ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚)
            if resource_limits.get('reset_interval') == 'daily':
                increment_daily_usage(current_user.id, resource_type)

            return result

        return wrapper
    return decorator
```

**Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:**

```python
@app.post('/api/cards')
@require_limit('cards')
async def create_card(
    request: CreateCardRequest,
    current_user: User = Depends(get_current_user)
):
    # Ð›Ð¸Ð¼Ð¸Ñ‚ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½ Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
    card = await create_card_for_user(current_user, request)
    return serialize_card(card)


@app.post('/api/exercises/generate')
@require_limit('exercises')
async def generate_exercise(
    request: GenerateExerciseRequest,
    current_user: User = Depends(get_current_user)
):
    # Ð›Ð¸Ð¼Ð¸Ñ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½, Ð¸Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½
    exercise = await llm_generate_exercise(current_user, request)
    return exercise
```

### Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¾ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°Ñ…

#### ÐŸÑ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°

**Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°:**

```json
{
  "error": {
    "code": "LIMIT_REACHED",
    "message": "Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (50)",
    "details": {
      "limit_type": "messages",
      "current": 50,
      "max": 50,
      "reset_at": "2025-01-09T00:00:00Z",
      "upgrade_url": "/profile/premium"
    }
  }
}
```

**Ð’ Ð±Ð¾Ñ‚Ðµ:**

```
âŒ Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (50)

Ð’Ð°ÑˆÐ¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· 3 Ñ‡Ð°ÑÐ° (Ð² 00:00 UTC).

ðŸ’Ž Ð¡ ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¾Ð¹ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ:
â€¢ 500 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð´ÐµÐ½ÑŒ (Ð²Ð¼ÐµÑÑ‚Ð¾ 50)
â€¢ ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ
â€¢ ÐÐµÐ¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸
â€¢ Ð”Ð¾ 10 ÑÐ·Ñ‹ÐºÐ¾Ð²Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹

[ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ â†’]
```

#### ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸ÐµÐ¼

ÐŸÑ€Ð¸ Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ðº Ð»Ð¸Ð¼Ð¸Ñ‚Ñƒ (80%) Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ:

```python
def check_limit_warning(user: User, resource_type: str):
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð½ÑƒÐ¶Ð½Ð¾ Ð»Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¾ Ð»Ð¸Ð¼Ð¸Ñ‚Ðµ.
    """
    limits = get_user_limits(user)
    resource = limits.get(resource_type, {})

    max_limit = resource.get('max')
    current = resource.get('used', 0)

    if max_limit is None:  # Unlimited
        return None

    threshold = max_limit * 0.8

    if current >= threshold and current < max_limit:
        return {
            'warning': True,
            'message': f"Ð’Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ {current} Ð¸Ð· {max_limit} {resource_type}",
            'remaining': max_limit - current,
            'reset_at': resource.get('reset_at')
        }

    return None
```

**Ð’ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ñ… API:**

```json
{
  "data": { ... },
  "limit_warning": {
    "warning": true,
    "message": "Ð’Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ 45 Ð¸Ð· 50 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹",
    "remaining": 5,
    "reset_at": "2025-01-09T00:00:00Z"
  }
}
```

#### Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð² Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ

**GET /api/users/me Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹:**

```json
{
  "id": "uuid",
  "telegram_id": 123456789,
  "is_premium": false,
  "limits": {
    "profiles": { "used": 1, "max": 1 },
    "messages": { "used": 45, "max": 50, "reset_at": "2025-01-09T00:00:00Z" },
    "exercises": { "used": 8, "max": 10, "reset_at": "2025-01-09T00:00:00Z" },
    "cards": { "used": 124, "max": 200 },
    "groups": { "used": 0, "max": 1 }
  }
}
```

**Ð’ Mini App:**

ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ-Ð±Ð°Ñ€Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°:

```
ðŸ“Š Ð’Ð°ÑˆÐ¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹

Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 45/50
Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 8/10
ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸:   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 124/200
ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸:    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 1/1

Ð¡Ð±Ñ€Ð¾Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ·: 3 Ñ‡Ð°ÑÐ°

[ðŸ’Ž ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼]
```

---

## Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°Ð¼Ð¸

### Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº

**Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° subscriptions:**

```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,

    -- Stripe
    stripe_customer_id VARCHAR(255) UNIQUE,
    stripe_subscription_id VARCHAR(255) UNIQUE,

    -- Subscription info
    status VARCHAR(20) NOT NULL CHECK (status IN ('free', 'trial', 'active', 'canceled', 'expired')),
    plan VARCHAR(20) CHECK (plan IN ('monthly', 'yearly')),

    -- Billing
    price DECIMAL(10, 2),
    currency VARCHAR(3) DEFAULT 'EUR',

    -- Periods
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,

    -- Cancellation
    cancel_at_period_end BOOLEAN NOT NULL DEFAULT FALSE,
    canceled_at TIMESTAMP,

    -- Payment method
    payment_method_type VARCHAR(50),
    payment_method_last4 VARCHAR(4),
    payment_method_brand VARCHAR(50),

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_stripe_customer ON subscriptions(stripe_customer_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_period_end ON subscriptions(current_period_end);

-- Trigger Ð´Ð»Ñ updated_at
CREATE TRIGGER update_subscriptions_updated_at BEFORE UPDATE ON subscriptions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑÑ‹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:**

| Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
|--------|----------|
| `free` | Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½ (Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð°) |
| `trial` | ÐŸÑ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´ (7 Ð´Ð½ÐµÐ¹) |
| `active` | ÐÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ð°Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° |
| `canceled` | ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð° (Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°) |
| `expired` | Ð˜ÑÑ‚ÐµÐºÐ»Ð° |

**Ð¡Ð²ÑÐ·ÑŒ Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÐµÐ¹ users:**

```sql
-- users table
is_premium BOOLEAN NOT NULL DEFAULT FALSE
premium_expires_at TIMESTAMP
trial_ends_at TIMESTAMP
trial_used BOOLEAN NOT NULL DEFAULT FALSE
```

- `is_premium` - ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
- `premium_expires_at` - Ð´Ð°Ñ‚Ð° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼Ð° (Ð¸Ð· subscription)
- `trial_ends_at` - Ð´Ð°Ñ‚Ð° Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ñ‚Ñ€Ð¸Ð°Ð»Ð°
- `trial_used` - Ñ„Ð»Ð°Ð³ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ‚Ñ€Ð¸Ð°Ð»Ð°

### Ð˜ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

**ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°:**

Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· cron job ÐºÐ°Ð¶Ð´Ñ‹Ðµ 15 Ð¼Ð¸Ð½ÑƒÑ‚:

```python
def check_expired_subscriptions():
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð¸ÑÑ‚ÐµÐºÑˆÐ¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¸ Ð´ÐµÐ°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼.
    """
    now = datetime.utcnow()

    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸ÑÑ‚ÐµÐºÑˆÐ¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
    expired_subscriptions = db.query(Subscription).filter(
        Subscription.status == 'active',
        Subscription.current_period_end <= now
    ).all()

    for subscription in expired_subscriptions:
        user = subscription.user

        # Ð”ÐµÐ°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼
        user.is_premium = False
        user.premium_expires_at = None
        subscription.status = 'expired'

        db.commit()

        # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
        send_notification(user, 'subscription_expired')

        logger.info(f"Subscription expired: user_id={user.id}")
```

**Cron Ð·Ð°Ð´Ð°Ñ‡Ð°:**

```bash
# crontab -e
*/15 * * * * python /app/scripts/check_expired_subscriptions.py
```

**Ð˜Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· pg_cron (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ PostgreSQL):**

```sql
SELECT cron.schedule(
    'check-expired-subscriptions',
    '*/15 * * * *',
    $$SELECT check_expired_subscriptions()$$
);
```

**Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ñ€Ð¸ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ð¸:**

1. **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸** Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ð½Ð° `expired`
2. **is_premium** ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð² `false`
3. **Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹** Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ ÐºÐ°Ðº Ð´Ð»Ñ free Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
   - Ð•ÑÐ»Ð¸ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº > 200 â†’ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
   - Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ > 1 â†’ Ð½ÐµÐ»ÑŒÐ·Ñ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ
   - Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹ â†’ 50/10 Ð² Ð´ÐµÐ½ÑŒ
4. **Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑŽÑ‚ÑÑ** - Ð²ÑÐµ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸, Ñ‚ÐµÐ¼Ñ‹, Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ
5. **ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ** Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ

**Grace period:**

Ð’ Ð½Ð°ÑˆÐµÐ¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ grace period Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ â€” Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾ Ð¿Ð¾ÑÐ»Ðµ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ.

### Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ð¸

**Ð—Ð° 7 Ð´Ð½ÐµÐ¹:**

```
ðŸ’Ž Ð’Ð°ÑˆÐ° ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· 7 Ð´Ð½ÐµÐ¹ (15 ÑÐ½Ð²Ð°Ñ€Ñ)

ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ:
â€¢ 50 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ (Ð²Ð¼ÐµÑÑ‚Ð¾ 500)
â€¢ 10 ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹/Ð´ÐµÐ½ÑŒ (Ð²Ð¼ÐµÑÑ‚Ð¾ Ð±ÐµÐ·Ð»Ð¸Ð¼Ð¸Ñ‚Ð°)
â€¢ ÐÐµ Ð±Ð¾Ð»ÐµÐµ 200 ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº

[ÐŸÑ€Ð¾Ð´Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ â†’]
```

**Ð—Ð° 3 Ð´Ð½Ñ:**

```
âš ï¸ ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· 3 Ð´Ð½Ñ

ÐŸÑ€Ð¾Ð´Ð»Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ ÐºÐ¾ Ð²ÑÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼.

[ÐŸÑ€Ð¾Ð´Ð»Ð¸Ñ‚ÑŒ ÑÐµÐ¹Ñ‡Ð°Ñ â†’]
```

**Ð—Ð° 1 Ð´ÐµÐ½ÑŒ:**

```
ðŸš¨ Ð’Ð°ÑˆÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚ Ð·Ð°Ð²Ñ‚Ñ€Ð°!

Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹, Ð½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑ‚ÑÑ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð½Ð°.

[ÐŸÑ€Ð¾Ð´Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ â†’]
```

**ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ:**

```
âŒ Ð’Ð°ÑˆÐ° ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð¸ÑÑ‚ÐµÐºÐ»Ð°

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð½Ð°:
â€¢ 50 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð´ÐµÐ½ÑŒ
â€¢ 10 ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹ Ð² Ð´ÐµÐ½ÑŒ
â€¢ Ð”Ð¾ 200 ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº

Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹.

[ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ ÑÐ½Ð¾Ð²Ð° â†’]
```

**Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ:**

```python
def send_subscription_expiration_reminders():
    """
    ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð¾ ÑÐºÐ¾Ñ€Ð¾Ð¼ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸.
    Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾.
    """
    now = datetime.utcnow()

    # Ð—Ð° 7 Ð´Ð½ÐµÐ¹
    expires_in_7_days = now + timedelta(days=7)
    send_reminders_for_date(expires_in_7_days, days_remaining=7)

    # Ð—Ð° 3 Ð´Ð½Ñ
    expires_in_3_days = now + timedelta(days=3)
    send_reminders_for_date(expires_in_3_days, days_remaining=3)

    # Ð—Ð° 1 Ð´ÐµÐ½ÑŒ
    expires_tomorrow = now + timedelta(days=1)
    send_reminders_for_date(expires_tomorrow, days_remaining=1)


def send_reminders_for_date(target_date: datetime, days_remaining: int):
    """
    ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº, Ð¸ÑÑ‚ÐµÐºÐ°ÑŽÑ‰Ð¸Ñ… Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ.
    """
    subscriptions = db.query(Subscription).filter(
        Subscription.status == 'active',
        Subscription.current_period_end >= target_date,
        Subscription.current_period_end < target_date + timedelta(days=1)
    ).all()

    for subscription in subscriptions:
        user = subscription.user

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ»Ð¸ Ð»Ð¸ ÑƒÐ¶Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ
        if already_sent_today(user.id, f'subscription_expiring_{days_remaining}d'):
            continue

        # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
        send_notification(user, 'subscription_expiring', {
            'days_remaining': days_remaining,
            'expires_at': subscription.current_period_end
        })

        # ÐŸÐ¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ ÐºÐ°Ðº Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ðµ
        mark_notification_sent(user.id, f'subscription_expiring_{days_remaining}d')
```

### Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¸ Ð°ÑƒÐ´Ð¸Ñ‚

**Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° subscription_history:**

```sql
CREATE TABLE subscription_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Event info
    event_type VARCHAR(50) NOT NULL,  -- 'activated', 'renewed', 'canceled', 'expired', 'manual_activation'

    -- Subscription details at the time
    status VARCHAR(20),
    plan VARCHAR(20),
    price DECIMAL(10, 2),
    currency VARCHAR(3),

    -- Metadata
    metadata JSONB,  -- Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (stripe_id, admin_id, reason Ð¸ Ñ‚.Ð´.)

    -- Timestamp
    timestamp TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹
CREATE INDEX idx_subscription_history_user_id ON subscription_history(user_id);
CREATE INDEX idx_subscription_history_timestamp ON subscription_history(timestamp);
CREATE INDEX idx_subscription_history_event_type ON subscription_history(event_type);
```

**Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹:**

```python
def log_subscription_event(
    user_id: UUID,
    event_type: str,
    subscription: Subscription = None,
    metadata: dict = None
):
    """
    Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ.
    """
    event = SubscriptionHistory(
        user_id=user_id,
        event_type=event_type,
        status=subscription.status if subscription else None,
        plan=subscription.plan if subscription else None,
        price=subscription.price if subscription else None,
        currency=subscription.currency if subscription else None,
        metadata=metadata or {}
    )

    db.add(event)
    db.commit()

    logger.info(f"Subscription event: user_id={user_id}, type={event_type}")


# ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
log_subscription_event(user.id, 'activated', subscription, {
    'stripe_subscription_id': subscription.stripe_subscription_id,
    'source': 'stripe_webhook'
})

log_subscription_event(user.id, 'manual_activation', None, {
    'admin_id': str(admin.id),
    'duration_days': 30,
    'reason': 'Compensation for bug'
})

log_subscription_event(user.id, 'expired', subscription, {
    'stripe_subscription_id': subscription.stripe_subscription_id
})
```

**Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ:**

```python
@app.get('/api/subscriptions/history')
def get_subscription_history(
    current_user: User = Depends(get_current_user),
    limit: int = 20,
    offset: int = 0
):
    """
    ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.
    """
    history = db.query(SubscriptionHistory).filter(
        SubscriptionHistory.user_id == current_user.id
    ).order_by(
        SubscriptionHistory.timestamp.desc()
    ).limit(limit).offset(offset).all()

    return {
        'data': [serialize_subscription_event(event) for event in history],
        'pagination': {
            'limit': limit,
            'offset': offset,
            'total': db.query(SubscriptionHistory).filter(
                SubscriptionHistory.user_id == current_user.id
            ).count()
        }
    }
```

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‚Ð°:**

```json
{
  "data": [
    {
      "event_type": "activated",
      "status": "active",
      "plan": "yearly",
      "price": "49.00",
      "currency": "EUR",
      "timestamp": "2025-01-08T12:00:00Z",
      "metadata": {
        "stripe_subscription_id": "sub_xxx",
        "source": "stripe_webhook"
      }
    },
    {
      "event_type": "trial_started",
      "status": "trial",
      "timestamp": "2025-01-01T12:00:00Z",
      "metadata": {}
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 2
  }
}
```

---

## Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ API endpoints

### ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

```
GET /api/subscriptions/status
```

**Response (Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°):**
```json
{
  "is_premium": true,
  "status": "active",
  "plan": "yearly",
  "price": "49.00",
  "currency": "EUR",
  "current_period_start": "2025-01-01T00:00:00Z",
  "current_period_end": "2026-01-01T00:00:00Z",
  "cancel_at_period_end": false,
  "payment_method": {
    "type": "card",
    "last4": "4242",
    "brand": "visa"
  }
}
```

**Response (free Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ):**
```json
{
  "is_premium": false,
  "status": "free",
  "trial_available": false,
  "trial_used": true,
  "trial_ended_at": "2025-01-08T00:00:00Z"
}
```

### Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ (Ð¸Ð½Ð²Ð¾Ð¹ÑÑ‹)

```
GET /api/subscriptions/invoices
```

**Response:**
```json
{
  "data": [
    {
      "id": "in_xxx",
      "amount": "49.00",
      "currency": "EUR",
      "status": "paid",
      "created": "2025-01-01T00:00:00Z",
      "invoice_pdf": "https://pay.stripe.com/invoice/xxx/pdf"
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 1
  }
}
```

---

Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð»Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¼Ð¾Ð½ÐµÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð´Ð»Ñ Telegram-Ð±Ð¾Ñ‚Ð° Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ·Ñ‹ÐºÐ¾Ð² Ñ Ð˜Ð˜-Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼.
