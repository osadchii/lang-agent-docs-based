# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ù–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Telegram**:

1. **Telegram Bot** - –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å –ò–ò-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **Telegram Mini App** - –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ (–∫–∞—Ä—Ç–æ—á–∫–∏, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è) –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–º/–≥—Ä—É–ø–ø–∞–º–∏

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**

| –§—É–Ω–∫—Ü–∏—è | Telegram Bot | Telegram Mini App |
|---------|--------------|-------------------|
| –î–∏–∞–ª–æ–≥ —Å –ò–ò | ‚úÖ | ‚ùå |
| –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ | ‚úÖ | ‚úÖ (—Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ) |
| –ü—Ä–∞–∫—Ç–∏–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ | ‚úÖ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è) | ‚úÖ (–ø–æ–ª–Ω–∞—è) |
| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è | ‚úÖ (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ) | ‚úÖ (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ + –≤—ã–±–æ—Ä) |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ | ‚úÖ (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ) | ‚úÖ (–ø–æ–ª–Ω–æ–µ) |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–¥–∞–º–∏ | ‚úÖ (–≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π) | ‚úÖ (CRUD) |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏ | ‚úÖ (–≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π) | ‚úÖ (CRUD) |
| –ì—Ä—É–ø–ø—ã | ‚ùå | ‚úÖ |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | ‚úÖ (–∫—Ä–∞—Ç–∫–∞—è) | ‚úÖ (–ø–æ–¥—Ä–æ–±–Ω–∞—è) |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç—Ä–∏–∫) | ‚úÖ | ‚úÖ (—á–µ—Ä–µ–∑ Mini App) |

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ:**
- **–ö–∞—Ä—Ç–æ—á–∫–∏:** –ü–æ–∫–∞–∑ –ø–æ –æ–¥–Ω–æ–π, –∫–Ω–æ–ø–∫–∏ "–í–∑—è—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É", "–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É", –æ—Ü–µ–Ω–∫–∞ (–ù–µ –∑–Ω–∞—é/–ü–æ–≤—Ç–æ—Ä–∏—Ç—å/–ó–Ω–∞—é)
- **–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:** –û–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ LLM
- **–ü—Ä–æ—Ñ–∏–ª–∏:** –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `/switch_profile` –∏ inline-–∫–Ω–æ–ø–∫–∏
- **–ö–æ–ª–æ–¥—ã:** –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π —á–µ—Ä–µ–∑ `/decks` (–∫–∞—Ä—Ç–æ—á–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–ª–æ–¥—ã)
- **–¢–µ–º—ã:** –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π —á–µ—Ä–µ–∑ `/topics` (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–µ–º–µ)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Mini App:**
- **–ö–∞—Ä—Ç–æ—á–∫–∏:** –†–µ–∂–∏–º —Å–µ—Å—Å–∏–∏ (10-20 –∫–∞—Ä—Ç–æ—á–µ–∫), –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏, —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞
- **–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:** –°–µ—Å—Å–∏–∏ 5-10 –∑–∞–¥–∞–Ω–∏–π, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä + —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥, –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- **–ü—Ä–æ—Ñ–∏–ª–∏:** –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
- **–ö–æ–ª–æ–¥—ã/–¢–µ–º—ã:** –ü–æ–ª–Ω–æ–µ CRUD —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
- **–ì—Ä—É–ø–ø—ã:** –°–æ–∑–¥–∞–Ω–∏–µ, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏, —à–∞—Ä–∏–Ω–≥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

---

## 1. Telegram Bot API

### 1.1. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** `python-telegram-bot` (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è 20+)

```bash
pip install python-telegram-bot[webhooks]
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**
- `aiogram` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- `pyTelegramBotAPI` (telebot) - –ø—Ä–æ—Å—Ç–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

**–î–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:** `python-telegram-bot` —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º

### 1.2. –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–æ—Ç–∞

```python
# bot.py
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters,
    ContextTypes
)
import logging

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)


class LanguageLearningBot:
    def __init__(self, token: str):
        self.application = Application.builder().token(token).build()
        self._register_handlers()

    def _register_handlers(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ handlers –±–æ—Ç–∞."""
        # –ö–æ–º–∞–Ω–¥—ã
        self.application.add_handler(CommandHandler("start", self.start_command))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("profile", self.profile_command))
        self.application.add_handler(CommandHandler("app", self.open_mini_app_command))
        self.application.add_handler(CommandHandler("stats", self.stats_command))

        # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
        self.application.add_handler(CommandHandler("card", self.get_card_command))
        self.application.add_handler(CommandHandler("decks", self.list_decks_command))

        # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        self.application.add_handler(CommandHandler("exercise", self.get_exercise_command))
        self.application.add_handler(CommandHandler("topics", self.list_topics_command))

        # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–∏–∞–ª–æ–≥ —Å LLM)
        self.application.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_text_message)
        )

        # Callback queries (inline –∫–Ω–æ–ø–∫–∏)
        self.application.add_handler(CallbackQueryHandler(self.handle_callback))

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        self.application.add_error_handler(self.error_handler)

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start."""
        user = update.effective_user
        telegram_id = user.id

        # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        db_user = await get_or_create_user(
            telegram_id=telegram_id,
            first_name=user.first_name,
            last_name=user.last_name,
            username=user.username
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ñ–∏–ª–∏
        profiles = await get_user_profiles(db_user.id)

        if not profiles:
            # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ Mini App
            keyboard = [
                [InlineKeyboardButton("–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ üöÄ", web_app={"url": f"{MINI_APP_URL}?start=onboarding"})]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n\n"
                "–Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ò–ò-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å. –ü–æ–º–æ–≥—É —Ç–µ–±–µ –≤—ã—É—á–∏—Ç—å –ª—é–±–æ–π —è–∑—ã–∫ —á–µ—Ä–µ–∑:\n"
                "‚Ä¢ üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É\n"
                "‚Ä¢ üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–ª–æ–≤\n"
                "‚Ä¢ üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É\n"
                "‚Ä¢ üë• –û–±—É—á–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–∞—Ö\n\n"
                "–î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º —Å –±—ã—Å—Ç—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!",
                reply_markup=reply_markup
            )
        else:
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            active_profile = next((p for p in profiles if p.is_active), profiles[0])

            keyboard = [
                [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": MINI_APP_URL})],
                [
                    InlineKeyboardButton("–ü—Ä–∞–∫—Ç–∏–∫–∞ üé¥", callback_data="practice"),
                    InlineKeyboardButton("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä", callback_data="stats")
                ]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user.first_name}! üéâ\n\n"
                f"–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: {active_profile.language_name} ({active_profile.current_level})\n"
                f"–°—Ç—Ä–∏–∫: {active_profile.streak} –¥–Ω–µ–π üî•\n\n"
                "–ß–µ–º –∑–∞–π–º–µ–º—Å—è —Å–µ–≥–æ–¥–Ω—è?",
                reply_markup=reply_markup
            )

    async def handle_text_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¥–∏–∞–ª–æ–≥ —Å LLM –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ."""
        user = update.effective_user
        message_text = update.message.text

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        db_user = await get_user_by_telegram_id(user.id)
        if not db_user:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ /start")
            return

        active_profile = await get_active_profile(db_user.id)
        if not active_profile:
            await update.message.reply_text(
                "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": MINI_APP_URL})
                ]])
            )
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
        if 'current_exercise' in context.user_data:
            exercise_id = context.user_data['current_exercise']
            del context.user_data['current_exercise']  # –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ LLM
            await update.message.chat.send_action("typing")

            result = await check_exercise_answer(
                exercise_id=exercise_id,
                user_answer=message_text
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            result_emoji = {"correct": "‚úÖ", "partial": "üü°", "incorrect": "‚ùå"}
            result_text_map = {"correct": "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "partial": "–ü–æ—á—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ", "incorrect": "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ"}

            response_text = (
                f"{result_emoji[result.result]} *{result_text_map[result.result]}*\n\n"
                f"*–í–∞—à –æ—Ç–≤–µ—Ç:* {message_text}\n"
                f"*–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:* {result.correct_answer}\n\n"
                f"üí° {result.explanation}"
            )

            if result.alternatives:
                response_text += f"\n\n*–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:* {', '.join(result.alternatives)}"

            keyboard = [
                [InlineKeyboardButton("–°–ª–µ–¥—É—é—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ üìù", callback_data="get_exercise")],
                [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": f"{MINI_APP_URL}?start=exercises"})]
            ]

            await update.message.reply_text(
                response_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏
            await save_exercise_result(
                user_id=db_user.id,
                exercise_id=exercise_id,
                user_answer=message_text,
                result=result.result
            )

            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
        if not await check_message_limit(db_user):
            await update.message.reply_text(
                "–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (50 –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞).\n\n"
                "–û—Ñ–æ—Ä–º–∏—Ç–µ Premium –¥–ª—è 500 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å!",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("–û—Ñ–æ—Ä–º–∏—Ç—å Premium üíé", callback_data="upgrade_premium")
                ]])
            )
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º typing action
        await update.message.chat.send_action("typing")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ LLM
        try:
            llm_response = await process_user_message(
                user=db_user,
                profile=active_profile,
                message=message_text,
                conversation_history=await get_conversation_history(db_user.id, active_profile.id)
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            await save_message_to_history(
                user_id=db_user.id,
                profile_id=active_profile.id,
                role="user",
                content=message_text
            )
            await save_message_to_history(
                user_id=db_user.id,
                profile_id=active_profile.id,
                role="assistant",
                content=llm_response.text
            )

            # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
            await increment_message_usage(db_user)

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            await update.message.reply_text(llm_response.text)

            # –ï—Å–ª–∏ LLM –ø—Ä–µ–¥–ª–æ–∂–∏–ª –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            if llm_response.suggested_words:
                keyboard = [[
                    InlineKeyboardButton(
                        f"–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞ –≤ –∫–æ–ª–æ–¥—É ({len(llm_response.suggested_words)})",
                        callback_data=f"add_words:{','.join(llm_response.suggested_words)}"
                    )
                ]]
                await update.message.reply_text(
                    "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏?",
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            else:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ (–µ—Å–ª–∏ –Ω–µ—Ç suggested_words)
                keyboard = [
                    [
                        InlineKeyboardButton("–í–∑—è—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É üé¥", callback_data="get_card"),
                        InlineKeyboardButton("–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ üìù", callback_data="get_exercise")
                    ]
                ]
                await update.message.reply_text(
                    "–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è?",
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )

        except Exception as e:
            logger.error(f"Error processing message: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
            )

    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries –æ—Ç inline –∫–Ω–æ–ø–æ–∫."""
        query = update.callback_query
        await query.answer()

        callback_data = query.data

        if callback_data == "practice":
            # –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∞–∫—Ç–∏–∫–∏
            keyboard = [
                [InlineKeyboardButton("–ö–∞—Ä—Ç–æ—á–∫–∏ üé¥", callback_data="get_card")],
                [InlineKeyboardButton("–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ üìù", callback_data="get_exercise")],
                [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": f"{MINI_APP_URL}?start=practice"})]
            ]
            await query.edit_message_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∞–∫—Ç–∏–∫–∏:",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        elif callback_data == "get_card":
            # –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–ª–æ–¥—ã
            user = await get_user_by_telegram_id(query.from_user.id)
            active_profile = await get_active_profile(user.id)
            active_deck = await get_active_deck(active_profile.id)

            # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É
            card = await get_next_card(active_deck.id)

            if not card:
                await query.edit_message_text(
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.\n\n"
                    "–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ —Å–æ –º–Ω–æ–π –∏–ª–∏ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!",
                    reply_markup=InlineKeyboardMarkup([[
                        InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": f"{MINI_APP_URL}?start=cards"})
                    ]])
                )
                return

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (—Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
            show_side = random.choice(['learning', 'native'])

            if show_side == 'learning':
                card_text = f"üé¥ *–ö–∞—Ä—Ç–æ—á–∫–∞*\n\n{card.word}\n\n_{card.example}_"
            else:
                card_text = f"üé¥ *–ö–∞—Ä—Ç–æ—á–∫–∞*\n\n{card.translation}\n\n_{card.example_translation}_"

            keyboard = [[
                InlineKeyboardButton("–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É üîÑ", callback_data=f"flip_card:{card.id}:{show_side}")
            ]]

            await query.edit_message_text(
                card_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        elif callback_data.startswith("flip_card:"):
            # –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
            _, card_id, current_side = callback_data.split(":")
            card = await get_card_by_id(card_id)

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
            card_text = (
                f"üé¥ *–ö–∞—Ä—Ç–æ—á–∫–∞*\n\n"
                f"*{card.word}* ‚Äî {card.translation}\n\n"
                f"_{card.example}_\n"
                f"_{card.example_translation}_"
            )

            keyboard = [
                [
                    InlineKeyboardButton("–ù–µ –∑–Ω–∞—é ‚ùå", callback_data=f"rate_card:{card.id}:dont_know"),
                    InlineKeyboardButton("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å üîÑ", callback_data=f"rate_card:{card.id}:repeat"),
                    InlineKeyboardButton("–ó–Ω–∞—é ‚úÖ", callback_data=f"rate_card:{card.id}:know")
                ]
            ]

            await query.edit_message_text(
                card_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        elif callback_data.startswith("rate_card:"):
            # –û—Ü–µ–Ω–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            _, card_id, rating = callback_data.split(":")

            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
            card = await rate_card(card_id, rating)

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            rating_emoji = {"dont_know": "‚ùå", "repeat": "üîÑ", "know": "‚úÖ"}
            rating_text = {"dont_know": "–ù–µ –∑–Ω–∞—é", "repeat": "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å", "know": "–ó–Ω–∞—é"}

            result_text = (
                f"{rating_emoji[rating]} *{rating_text[rating]}*\n\n"
                f"–°–ª–µ–¥—É—é—â–∏–π –ø–æ–∫–∞–∑ —á–µ—Ä–µ–∑ {card.interval_days} –¥–Ω–µ–π\n"
                f"–î–∞—Ç–∞: {card.next_review.strftime('%d.%m.%Y')}"
            )

            keyboard = [
                [InlineKeyboardButton("–°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ üé¥", callback_data="get_card")],
                [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": f"{MINI_APP_URL}?start=cards"})]
            ]

            await query.edit_message_text(
                result_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        elif callback_data == "get_exercise":
            # –ü–æ–ª—É—á–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–µ–º–µ
            user = await get_user_by_telegram_id(query.from_user.id)
            active_profile = await get_active_profile(user.id)
            active_topic = await get_active_topic(active_profile.id)

            if not active_topic:
                await query.edit_message_text(
                    "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–µ–º—ã –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.\n\n"
                    "–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–º—É —á–µ—Ä–µ–∑ /add_topic –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ /topics",
                    reply_markup=InlineKeyboardMarkup([[
                        InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": f"{MINI_APP_URL}?start=exercises"})
                    ]])
                )
                return

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            if not await check_exercise_limit(user):
                await query.edit_message_text(
                    "–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (10 –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞).\n\n"
                    "–û—Ñ–æ—Ä–º–∏—Ç–µ Premium –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π!",
                    reply_markup=InlineKeyboardMarkup([[
                        InlineKeyboardButton("–û—Ñ–æ—Ä–º–∏—Ç—å Premium üíé", callback_data="upgrade_premium")
                    ]])
                )
                return

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
            exercise = await generate_exercise(
                user=user,
                profile=active_profile,
                topic=active_topic
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞
            context.user_data['current_exercise'] = exercise.id

            exercise_text = (
                f"üìù *–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: {active_topic.name}*\n\n"
                f"{exercise.question}\n\n"
                f"_{exercise.prompt}_\n\n"
                f"üí° –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏"
            )

            keyboard = [[
                InlineKeyboardButton("–ü–æ–¥—Å–∫–∞–∑–∫–∞ üí°", callback_data=f"hint_exercise:{exercise.id}")
            ]]

            await query.edit_message_text(
                exercise_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        elif callback_data == "stats":
            # –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            user = await get_user_by_telegram_id(query.from_user.id)
            active_profile = await get_active_profile(user.id)
            stats = await get_profile_stats(active_profile.id)

            await query.edit_message_text(
                f"üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({active_profile.language_name}):\n\n"
                f"üî• –°—Ç—Ä–∏–∫: {stats.streak} –¥–Ω–µ–π\n"
                f"üé¥ –ö–∞—Ä—Ç–æ—á–µ–∫ –∏–∑—É—á–µ–Ω–æ: {stats.cards_studied}\n"
                f"üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {stats.exercises_completed}\n"
                f"‚è± –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: {stats.total_minutes} –º–∏–Ω—É—Ç\n\n"
                "–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": MINI_APP_URL})
                ]])
            )

        elif callback_data.startswith("add_words:"):
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤ –≤ –∫–æ–ª–æ–¥—É
            words_str = callback_data.split(":", 1)[1]
            words = words_str.split(",")

            user = await get_user_by_telegram_id(query.from_user.id)
            active_profile = await get_active_profile(user.id)
            active_deck = await get_active_deck(active_profile.id)

            try:
                # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ LLM
                created_cards = await create_cards_from_words(
                    deck_id=active_deck.id,
                    words=words,
                    source_language=active_profile.language,
                    target_language="ru"
                )

                await query.edit_message_text(
                    f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {len(created_cards)} –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∫–æ–ª–æ–¥—É '{active_deck.name}'!\n\n"
                    "–û–Ω–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
                    reply_markup=InlineKeyboardMarkup([[
                        InlineKeyboardButton("–ò–∑—É—á–∏—Ç—å —Å–µ–π—á–∞—Å üé¥", web_app={"url": f"{MINI_APP_URL}?start=cards"})
                    ]])
                )

            except Exception as e:
                logger.error(f"Error adding words: {e}")
                await query.edit_message_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ª–æ–≤.")

        elif callback_data == "upgrade_premium":
            # –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Ñ–æ—Ä–º–∏—Ç—å Premium
            keyboard = [[
                InlineKeyboardButton("–û—Ñ–æ—Ä–º–∏—Ç—å Premium üíé", web_app={"url": f"{MINI_APP_URL}?start=premium"})
            ]]
            await query.edit_message_text(
                "üíé Premium –ø–æ–¥–ø–∏—Å–∫–∞:\n\n"
                "‚úÖ 500 —Å–æ–æ–±—â–µ–Ω–∏–π LLM –≤ –¥–µ–Ω—å (–≤–º–µ—Å—Ç–æ 50)\n"
                "‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è\n"
                "‚úÖ –î–æ 10 —è–∑—ã–∫–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π\n"
                "‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã\n"
                "‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
                "–û—Ç 4.99‚Ç¨/–º–µ—Å—è—Ü",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫."""
        logger.error(f"Exception while handling update: {context.error}")

    def run_webhook(self, webhook_url: str, port: int = 8443):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ webhook."""
        self.application.run_webhook(
            listen="0.0.0.0",
            port=port,
            url_path=f"/telegram-webhook/{BOT_TOKEN}",
            webhook_url=f"{webhook_url}/telegram-webhook/{BOT_TOKEN}"
        )

    def run_polling(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ long polling."""
        self.application.run_polling()


# –ó–∞–ø—É—Å–∫
if __name__ == "__main__":
    bot = LanguageLearningBot(token=BOT_TOKEN)

    # Production: webhook
    if os.getenv("APP_ENV") == "production":
        bot.run_webhook(webhook_url=WEBHOOK_URL)
    # Development: polling
    else:
        bot.run_polling()
```

> ‚ö†Ô∏è Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `setWebhook`, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω `BACKEND_DOMAIN` (URL —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–∞–∫ `https://<BACKEND_DOMAIN>`). –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –¥–æ–º–µ–Ω –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –ø–æ–∫–∞ DNS –Ω–µ –ø—Ä–∏–∫—Ä—É—á–µ–Ω –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É –∞–¥—Ä–µ—Å—É: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ hostname —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è, –∏ –∏–Ω–∞—á–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É (–±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ polling).

---

### 1.3. –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

**–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ (BotFather):**

```
start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
help - –ü–æ–º–æ—â—å –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
app - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
profile - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏
```

**–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥:**

#### /start

**–î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
- –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ" (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º)

**–î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö:**
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º
- –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∏ —Å—Ç—Ä–∏–∫
- –ö–Ω–æ–ø–∫–∏: "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "–ü—Ä–∞–∫—Ç–∏–∫–∞", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"

**Deep linking:**
```
/start onboarding - –û—Ç–∫—Ä—ã—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
/start practice - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
/start premium - –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É Premium
```

#### /help

```python
async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
    ü§ñ –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞

    *–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:*
    ‚Ä¢ –ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ –º–Ω–µ - —è –æ—Ç–≤–µ—á—É –∏ –ø–æ–º–æ–≥—É –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —è–∑—ã–∫
    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /app –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚Ä¢ /profile - –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚Ä¢ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è

    *–ü—Ä–∞–∫—Ç–∏–∫–∞:*
    ‚Ä¢ üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏ - –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–ª–æ–≤
    ‚Ä¢ üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è - –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ –∏ –ø–∏—Å—å–º–æ
    ‚Ä¢ üí¨ –î–∏–∞–ª–æ–≥ —Å–æ –º–Ω–æ–π - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞

    *–ì—Ä—É–ø–ø—ã:*
    ‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
    ‚Ä¢ –î–µ–ª–∏—Ç–µ—Å—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Å —É—á–µ–Ω–∏–∫–∞–º–∏

    –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º: @support_username
    """
    await update.message.reply_text(help_text, parse_mode="Markdown")
```

#### /app

```python
async def open_mini_app_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[
        InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": MINI_APP_URL})
    ]]
    await update.message.reply_text(
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

#### /profile

```python
async def profile_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = await get_user_by_telegram_id(update.effective_user.id)
    profiles = await get_user_profiles(user.id)
    active_profile = next((p for p in profiles if p.is_active), None)

    if active_profile:
        profile_text = f"""
        üë§ *–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å*

        –Ø–∑—ã–∫: {active_profile.language_name}
        –£—Ä–æ–≤–µ–Ω—å: {active_profile.current_level} ‚Üí {active_profile.target_level}
        –°—Ç—Ä–∏–∫: {active_profile.streak} –¥–Ω–µ–π üî•

        –ö–∞—Ä—Ç–æ—á–µ–∫: {active_profile.cards_count}
        –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: {active_profile.exercises_count}

        –ü–æ–¥–ø–∏—Å–∫–∞: {'Premium üíé' if user.is_premium else 'Free'}
        """

        keyboard = [[
            InlineKeyboardButton("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", web_app={"url": f"{MINI_APP_URL}?start=profile"})
        ]]

        await update.message.reply_text(
            profile_text,
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.")
```

#### /stats

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø–æ–¥—Ä–æ–±–Ω–∞—è –≤ Mini App).

---

### 1.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π:**
1. **–ö–æ–º–∞–Ω–¥—ã** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è CommandHandler
2. **–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç** - –¥–∏–∞–ª–æ–≥ —Å LLM —á–µ—Ä–µ–∑ MessageHandler

**–§–∏–ª—å—Ç—Ä—ã:**
```python
# –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –∏—Å–∫–ª—é—á–∞—è –∫–æ–º–∞–Ω–¥—ã
MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_message)
```

#### –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `app/telegram/bot.TelegramBot._handle_voice_message`.**

–§–ª–æ—É:

1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã `VOICE_MAX_DURATION_SECONDS` –∏ `VOICE_MAX_FILE_SIZE_BYTES`. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –æ—Ç–≤–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –Ω–µ —Ö–æ–¥–∏–º –≤ OpenAI.
2. –°–∫–∞—á–∏–≤–∞–µ–º OGG —á–µ—Ä–µ–∑ `context.bot.get_file(...)`, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–≤–µ—Ä—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä payload.
3. –ü–µ—Ä–µ–¥–∞—ë–º –±–∞–π—Ç—ã –≤ `SpeechToTextService` (`app/services/speech_to_text.py`), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç Whisper (`VOICE_TRANSCRIPTION_MODEL`, `VOICE_TRANSCRIPTION_TIMEOUT`) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `SpeechToTextResult`.
4. –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –ø—É—Å—Ç–æ–π ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –æ—à–∏–±–∫–æ–π. –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ —Ç–æ—Ç –∂–µ `DialogService`, —á—Ç–æ –∏ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ—ç—Ç–æ–º—É —Å—Ç—Ä–æ–∫–∞ —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `conversation_history`.

```python
async def handle_voice_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    voice = update.message.voice
    if voice.duration > settings.voice_max_duration_seconds:
        await update.message.reply_text("‚ö†Ô∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ.")
        return

    file = await context.bot.get_file(voice.file_id)
    audio_bytes = await file.download_as_bytearray()

    transcript = await speech_to_text.transcribe(
        audio_bytes,
        language_hint=profile.language,
    )

    await dialog_service.process_message(
        user=db_user,
        profile_id=profile.id,
        message=transcript.text,
    )
```

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π:

```python
self.application.add_handler(MessageHandler(filters.VOICE, self.handle_voice_message))
```

#### –§–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã

**–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–ª–æ—É**, –Ω–æ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å:

```python
async def handle_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞)."""
    photo = update.message.photo[-1]  # –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ

    # –°–∫–∞—á–∞—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ OCR
    file = await context.bot.get_file(photo.file_id)
    # ...
```

#### Callback Queries (Inline –∫–Ω–æ–ø–∫–∏)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ callback_data:**
- –ü—Ä–æ—Å—Ç–æ–π action: `"practice"`, `"stats"`, `"upgrade_premium"`
- –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: `"add_words:casa,perro,gato"`, `"select_profile:uuid"`

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```python
async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # –í–ê–ñ–ù–û: –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å answer()

    callback_data = query.data

    if callback_data.startswith("add_words:"):
        words = callback_data.split(":", 1)[1].split(",")
        # –û–±—Ä–∞–±–æ—Ç–∫–∞...
    # ...
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- `callback_data` –º–∞–∫—Å–∏–º—É–º 64 –±–∞–π—Ç–∞
- –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î: `callback_data="action:uuid"`

---

### 1.5. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –º–µ–Ω—é

#### Inline Keyboard (InlineKeyboardMarkup)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ callback_data
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ web_app (–¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ URL

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
# 1. Web App –∫–Ω–æ–ø–∫–∞
keyboard = [[
    InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ üì±", web_app={"url": MINI_APP_URL})
]]

# 2. Callback –∫–Ω–æ–ø–∫–∏
keyboard = [
    [
        InlineKeyboardButton("–ü—Ä–∞–∫—Ç–∏–∫–∞ üé¥", callback_data="practice"),
        InlineKeyboardButton("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä", callback_data="stats")
    ],
    [InlineKeyboardButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è", callback_data="settings")]
]

# 3. URL –∫–Ω–æ–ø–∫–∞
keyboard = [[
    InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç üåê", url="https://example.com")
]]

# 4. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è
keyboard = [
    [InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": MINI_APP_URL})],
    [
        InlineKeyboardButton("–ü—Ä–∞–∫—Ç–∏–∫–∞", callback_data="practice"),
        InlineKeyboardButton("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")
    ]
]

reply_markup = InlineKeyboardMarkup(keyboard)
await update.message.reply_text("–¢–µ–∫—Å—Ç", reply_markup=reply_markup)
```

#### Reply Keyboard (ReplyKeyboardMarkup)

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- Mini App - –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- Reply keyboard –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- Inline keyboard –±–æ–ª–µ–µ –≥–∏–±–∫–∞—è

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ:**
```python
from telegram import ReplyKeyboardMarkup, KeyboardButton

keyboard = [
    [KeyboardButton("–ü—Ä–∞–∫—Ç–∏–∫–∞ üé¥"), KeyboardButton("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä")],
    [KeyboardButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è")]
]

reply_markup = ReplyKeyboardMarkup(
    keyboard,
    resize_keyboard=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä
    one_time_keyboard=False  # –ù–µ —Å–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
)
```

#### Menu Button (Telegram Bot Menu)

**–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ BotFather:**
```
/setmenubutton ‚Üí –≤—ã–±—Ä–∞—Ç—å –±–æ—Ç–∞ ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å URL Mini App
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ API:**
```python
await context.bot.set_chat_menu_button(
    menu_button={
        "type": "web_app",
        "text": "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        "web_app": {"url": MINI_APP_URL}
    }
)
```

---

### 1.6. Webhook vs Long Polling

#### Long Polling (–¥–ª—è Development)

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
1. –ë–æ—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Telegram: "–ï—Å—Ç—å –Ω–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è?"
2. Telegram –¥–µ—Ä–∂–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ 30 —Å–µ–∫)
3. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö
4. –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (–Ω–µ –Ω—É–∂–µ–Ω SSL, –¥–æ–º–µ–Ω)
- –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
- –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 1-2 —Å–µ–∫—É–Ω–¥
- –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è high-load

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```python
def run_polling(self):
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ long polling."""
    self.application.run_polling(
        allowed_updates=Update.ALL_TYPES,  # –ö–∞–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç—å
        drop_pending_updates=True  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    )
```

#### Webhook (–¥–ª—è Production)

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
2. –°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
3. –ù–∏–∫–∞–∫–∏—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- Telegram —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –¥–ª—è production

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ù—É–∂–µ–Ω SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (HTTPS)
- –ù—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ–º–µ–Ω
- –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook:**
```python
async def set_webhook(bot_token: str, webhook_url: str):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –¥–ª—è –±–æ—Ç–∞."""
    url = f"https://api.telegram.org/bot{bot_token}/setWebhook"
    data = {
        "url": f"{webhook_url}/telegram-webhook/{bot_token}",
        "allowed_updates": ["message", "callback_query"],
        "drop_pending_updates": True
    }

    response = requests.post(url, json=data)
    return response.json()
```

2. **Endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (FastAPI):**
```python
from fastapi import FastAPI, Request
from telegram import Update

app = FastAPI()

@app.post("/telegram-webhook/{bot_token}")
async def telegram_webhook(bot_token: str, request: Request):
    """
    Endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if bot_token != BOT_TOKEN:
        return {"error": "Invalid token"}

    # –ü–æ–ª—É—á–∞–µ–º JSON
    data = await request.json()

    # –°–æ–∑–¥–∞–µ–º Update –æ–±—ä–µ–∫—Ç
    update = Update.de_json(data, bot.application.bot)

    # –ü–µ—Ä–µ–¥–∞–µ–º –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    await bot.application.process_update(update)

    return {"ok": True}
```

3. **Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    location /telegram-webhook/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**
- **Development:** Long Polling
- **Production:** Webhook

---

### 1.7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞

#### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å—Ç—Ä–∏–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö, –∏ –º—ã —Ö–æ—Ç–∏–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ 18:00 –ø–æ **–∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏**.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∂–¥—ã–π —á–∞—Å –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –¥–ª—è –∫–æ–≥–æ —Å–µ–π—á–∞—Å 18:00 –ø–æ –∏—Ö —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É.

**–•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞–π–º–∑–æ–Ω—ã:**
- –í —Ç–∞–±–ª–∏—Ü–µ `users` –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ `timezone` (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Europe/Moscow", "America/New_York")
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∞–π–º–∑–æ–Ω—É –∏–∑ `language_code` (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ) –∏–ª–∏ –∏–∑ Telegram API
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —á–µ—Ä–µ–∑ Mini App

```python
import asyncio
from datetime import datetime, timedelta
import pytz

async def send_streak_reminders():
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Å–µ–π—á–∞—Å 18:00 –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å.
    """
    current_utc_time = datetime.now(pytz.UTC)

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ —Å—Ç—Ä–∏–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è
    # –∏ —É –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –æ—Ç–º–µ—Ç–∫–∏ –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    users_to_check = await get_users_with_active_streak()

    for user in users_to_check:
        try:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_timezone = pytz.timezone(user.timezone or 'UTC')
            user_local_time = current_utc_time.astimezone(user_timezone)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–π—á–∞—Å 18:00 (—Å –æ–∫–Ω–æ–º ¬±30 –º–∏–Ω—É—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if 17 <= user_local_time.hour < 19:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Å–µ–≥–æ–¥–Ω—è
                if await should_send_reminder(user.id, user_local_time.date()):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–Ω–∏–º–∞–ª—Å—è —Å–µ–≥–æ–¥–Ω—è
                    if not await has_activity_today(user.id, user_local_time.date()):
                        await bot.application.bot.send_message(
                            chat_id=user.telegram_id,
                            text=f"üî• –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ —Å—Ç—Ä–∏–∫–µ!\n\n"
                                 f"–£ –≤–∞—Å {user.current_streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –æ–±—É—á–µ–Ω–∏—è. "
                                 f"–°–¥–µ–ª–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∏–∫!",
                            reply_markup=InlineKeyboardMarkup([[
                                InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": MINI_APP_URL})
                            ]])
                        )

                        # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                        await mark_reminder_sent(user.id, user_local_time.date())

                        logger.info(f"Streak reminder sent to user {user.id} (timezone: {user.timezone}, local time: {user_local_time})")

        except Exception as e:
            logger.error(f"Failed to send reminder to {user.telegram_id}: {e}")

        # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å rate limit Telegram
        await asyncio.sleep(0.05)  # 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É


async def should_send_reminder(user_id: str, today: date) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–µ–≥–æ–¥–Ω—è.
    """
    reminder = await db.query(StreakReminder).filter(
        StreakReminder.user_id == user_id,
        StreakReminder.sent_date == today
    ).first()

    return reminder is None


async def mark_reminder_sent(user_id: str, sent_date: date):
    """
    –ü–æ–º–µ—á–∞–µ—Ç, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.
    """
    reminder = StreakReminder(
        user_id=user_id,
        sent_date=sent_date,
        sent_at=datetime.utcnow()
    )
    db.add(reminder)
    await db.commit()


# –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (APScheduler, Celery, –∏–ª–∏ cron)
from apscheduler.schedulers.asyncio import AsyncIOScheduler

scheduler = AsyncIOScheduler()

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å (–≤ –Ω–∞—á–∞–ª–µ —á–∞—Å–∞)
scheduler.add_job(send_streak_reminders, 'cron', hour='*', minute=0)

scheduler.start()
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**

```python
async def send_streak_reminders_optimized():
    """
    –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
    –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Å–µ–π—á–∞—Å –ø—Ä–∏–º–µ—Ä–Ω–æ 18:00 –ø–æ –∏—Ö —Ç–∞–π–º–∑–æ–Ω–µ.
    """
    current_utc_time = datetime.now(pytz.UTC)
    current_utc_hour = current_utc_time.hour

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∑–æ–Ω—ã –∏–∑ –ë–î
    timezones = await db.query(User.timezone).distinct().all()

    for (tz_name,) in timezones:
        if not tz_name:
            continue

        try:
            tz = pytz.timezone(tz_name)
            local_time = current_utc_time.astimezone(tz)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —ç—Ç–æ–π —Ç–∞–π–º–∑–æ–Ω–µ —Å–µ–π—á–∞—Å 18:00 (—Å –æ–∫–Ω–æ–º)
            if 17 <= local_time.hour < 19:
                # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —ç—Ç–æ–π —Ç–∞–π–º–∑–æ–Ω–æ–π
                users = await get_users_for_timezone_reminder(tz_name, local_time.date())

                for user in users:
                    try:
                        await bot.application.bot.send_message(
                            chat_id=user.telegram_id,
                            text=f"üî• –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ —Å—Ç—Ä–∏–∫–µ!\n\n"
                                 f"–£ –≤–∞—Å {user.current_streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –æ–±—É—á–µ–Ω–∏—è. "
                                 f"–°–¥–µ–ª–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∏–∫!",
                            reply_markup=InlineKeyboardMarkup([[
                                InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": MINI_APP_URL})
                            ]])
                        )

                        await mark_reminder_sent(user.id, local_time.date())
                        await asyncio.sleep(0.05)

                    except Exception as e:
                        logger.error(f"Failed to send reminder to {user.telegram_id}: {e}")

        except Exception as e:
            logger.error(f"Error processing timezone {tz_name}: {e}")
```

**–ú–æ–¥–µ–ª—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

```python
class StreakReminder(Base):
    __tablename__ = 'streak_reminders'

    id = Column(UUID, primary_key=True, default=uuid4)
    user_id = Column(UUID, ForeignKey('users.id'), nullable=False)
    sent_date = Column(Date, nullable=False)  # –î–∞—Ç–∞ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    sent_at = Column(DateTime, default=datetime.utcnow)  # UTC –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏

    __table_args__ = (
        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint: –æ–¥–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–µ–Ω—å
        UniqueConstraint('user_id', 'sent_date', name='unique_user_reminder_per_day'),
    )
```

**–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

1. **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –ï—Å–ª–∏ —Ç–∞–π–º–∑–æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º UTC –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ `language_code`:
   ```python
   TIMEZONE_BY_LANGUAGE = {
       'ru': 'Europe/Moscow',
       'en': 'Europe/London',
       'es': 'Europe/Madrid',
       'de': 'Europe/Berlin',
       # –∏ —Ç.–¥.
   }
   ```

2. **–û–∫–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–∫–Ω–æ 17:00-19:00, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:** –•—Ä–∞–Ω–∏–º –æ—Ç–º–µ—Ç–∫—É –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

4. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π –∏–∑ `streak_reminders`

#### –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã

```python
async def send_group_invite(user_telegram_id: int, group_name: str, inviter_name: str, invite_id: str):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏ –≤ –≥—Ä—É–ø–ø—É."""
    keyboard = [
        [
            InlineKeyboardButton("–ü—Ä–∏–Ω—è—Ç—å ‚úÖ", callback_data=f"accept_invite:{invite_id}"),
            InlineKeyboardButton("–û—Ç–∫–ª–æ–Ω–∏—Ç—å ‚ùå", callback_data=f"decline_invite:{invite_id}")
        ]
    ]

    await bot.application.bot.send_message(
        chat_id=user_telegram_id,
        text=f"üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É\n\n"
             f"{inviter_name} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å –≤ –≥—Ä—É–ø–ø—É '{group_name}'.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

---

## 2. Telegram Mini App

### 2.1. –ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Mini App

**Telegram Mini App** - —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (HTML/CSS/JS), –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram –≤ WebView.

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π UI (React, Vue, Angular)
- –î–æ—Å—Ç—É–ø –∫ Telegram WebApp API
- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ initData)
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–æ–º
- –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Telegram Payments

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Telegram
- –†–∞–∑–º–µ—Ä initial bundle –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–∏–º (< 5 MB)
- –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ file system, camera, microphone (—á–µ—Ä–µ–∑ WebView API)

---

### 2.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mini App

#### React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```
frontend/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useTelegram.ts
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ client.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ package.json
```

**1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK:**

`public/index.html`:
```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Language Learning App</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
```

**2. TypeScript —Ç–∏–ø—ã –¥–ª—è Telegram WebApp:**

`src/types/telegram.d.ts`:
```typescript
interface TelegramWebApp {
  initData: string;
  initDataUnsafe: {
    user?: {
      id: number;
      first_name: string;
      last_name?: string;
      username?: string;
      language_code?: string;
    };
    start_param?: string;
  };
  version: string;
  platform: string;
  colorScheme: 'light' | 'dark';
  themeParams: {
    bg_color: string;
    text_color: string;
    hint_color: string;
    link_color: string;
    button_color: string;
    button_text_color: string;
  };
  isExpanded: boolean;
  viewportHeight: number;
  viewportStableHeight: number;
  headerColor: string;
  backgroundColor: string;
  BackButton: {
    isVisible: boolean;
    onClick: (callback: () => void) => void;
    offClick: (callback: () => void) => void;
    show: () => void;
    hide: () => void;
  };
  MainButton: {
    text: string;
    color: string;
    textColor: string;
    isVisible: boolean;
    isActive: boolean;
    isProgressVisible: boolean;
    setText: (text: string) => void;
    onClick: (callback: () => void) => void;
    offClick: (callback: () => void) => void;
    show: () => void;
    hide: () => void;
    enable: () => void;
    disable: () => void;
    showProgress: (leaveActive: boolean) => void;
    hideProgress: () => void;
  };
  HapticFeedback: {
    impactOccurred: (style: 'light' | 'medium' | 'heavy' | 'rigid' | 'soft') => void;
    notificationOccurred: (type: 'error' | 'success' | 'warning') => void;
    selectionChanged: () => void;
  };
  ready: () => void;
  expand: () => void;
  close: () => void;
  sendData: (data: string) => void;
  openLink: (url: string) => void;
  openTelegramLink: (url: string) => void;
  showPopup: (params: {
    title?: string;
    message: string;
    buttons: Array<{ id?: string; type: string; text?: string }>;
  }, callback?: (buttonId: string) => void) => void;
  showAlert: (message: string, callback?: () => void) => void;
  showConfirm: (message: string, callback?: (confirmed: boolean) => void) => void;
}

interface Window {
  Telegram: {
    WebApp: TelegramWebApp;
  };
}
```

**3. React Hook –¥–ª—è Telegram WebApp:**

`src/hooks/useTelegram.ts`:
```typescript
import { useEffect, useState } from 'react';

export const useTelegram = () => {
  const [webApp, setWebApp] = useState<TelegramWebApp | null>(null);

  useEffect(() => {
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      setWebApp(tg);
    }
  }, []);

  return {
    webApp,
    user: webApp?.initDataUnsafe?.user,
    initData: webApp?.initData,
    colorScheme: webApp?.colorScheme,
    themeParams: webApp?.themeParams,
  };
};
```

**4. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**

`src/App.tsx`:
```typescript
import React, { useEffect, useState } from 'react';
import { useTelegram } from './hooks/useTelegram';
import { authenticateUser } from './api/auth';

function App() {
  const { initData, user } = useTelegram();
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [jwtToken, setJwtToken] = useState<string | null>(null);

  useEffect(() => {
    const authenticate = async () => {
      if (!initData) {
        console.error('No initData from Telegram');
        return;
      }

      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –Ω–∞ backend –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        const response = await fetch('/api/auth/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: initData })
        });

        if (response.ok) {
          const data = await response.json();
          setJwtToken(data.token);
          localStorage.setItem('jwt_token', data.token);
          setIsAuthenticated(true);
        } else {
          console.error('Authentication failed');
        }
      } catch (error) {
        console.error('Authentication error:', error);
      }
    };

    authenticate();
  }, [initData]);

  if (!isAuthenticated) {
    return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  }

  return (
    <div className="app">
      <h1>–ü—Ä–∏–≤–µ—Ç, {user?.first_name}!</h1>
      {/* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */}
    </div>
  );
}

export default App;
```

---

### 2.3. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram UI

#### Back Button

```typescript
import { useEffect } from 'react';
import { useTelegram } from './hooks/useTelegram';
import { useNavigate } from 'react-router-dom';

function SomeScreen() {
  const { webApp } = useTelegram();
  const navigate = useNavigate();

  useEffect(() => {
    if (!webApp) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    webApp.BackButton.show();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è
    const handleBackClick = () => {
      navigate(-1); // –∏–ª–∏ navigate('/home')
    };

    webApp.BackButton.onClick(handleBackClick);

    // Cleanup
    return () => {
      webApp.BackButton.hide();
      webApp.BackButton.offClick(handleBackClick);
    };
  }, [webApp, navigate]);

  return <div>...</div>;
}
```

#### Main Button

```typescript
function CardReviewScreen() {
  const { webApp } = useTelegram();

  useEffect(() => {
    if (!webApp) return;

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    webApp.MainButton.setText('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é');
    webApp.MainButton.show();
    webApp.MainButton.enable();

    const handleFinish = () => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      finishSession();
    };

    webApp.MainButton.onClick(handleFinish);

    return () => {
      webApp.MainButton.hide();
      webApp.MainButton.offClick(handleFinish);
    };
  }, [webApp]);

  return <div>...</div>;
}
```

#### Haptic Feedback

```typescript
function CardRatingButtons() {
  const { webApp } = useTelegram();

  const handleRate = (rating: 'know' | 'repeat' | 'dont_know') => {
    // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    if (webApp) {
      if (rating === 'know') {
        webApp.HapticFeedback.notificationOccurred('success');
      } else if (rating === 'dont_know') {
        webApp.HapticFeedback.notificationOccurred('error');
      } else {
        webApp.HapticFeedback.impactOccurred('medium');
      }
    }

    // –û—Ü–µ–Ω–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    rateCard(rating);
  };

  return (
    <div>
      <button onClick={() => handleRate('dont_know')}>–ù–µ –∑–Ω–∞—é</button>
      <button onClick={() => handleRate('repeat')}>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      <button onClick={() => handleRate('know')}>–ó–Ω–∞—é</button>
    </div>
  );
}
```

#### Popup, Alert, Confirm

```typescript
// Alert
webApp.showAlert('–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', () => {
  console.log('Alert closed');
});

// Confirm
webApp.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å?', (confirmed) => {
  if (confirmed) {
    deleteProfile();
  }
});

// Popup —Å –∫–Ω–æ–ø–∫–∞–º–∏
webApp.showPopup({
  title: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
  message: '–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–æ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π?',
  buttons: [
    { id: 'edit', type: 'default', text: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' },
    { id: 'delete', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' },
    { id: 'cancel', type: 'cancel' }
  ]
}, (buttonId) => {
  if (buttonId === 'edit') {
    editCard();
  } else if (buttonId === 'delete') {
    deleteCard();
  }
});
```

---

### 2.4. Deep Linking

**Deep linking** –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å Mini App —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —ç–∫—Ä–∞–Ω–æ–º/—Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.

#### –ò–∑ –±–æ—Ç–∞ –≤ Mini App

**1. –ß–µ—Ä–µ–∑ web_app URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:**

```python
# –í –±–æ—Ç–µ
keyboard = [[
    InlineKeyboardButton(
        "–ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É",
        web_app={"url": f"{MINI_APP_URL}?start=practice"}
    )
]]
```

**2. –í React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**

```typescript
function App() {
  const { webApp } = useTelegram();
  const navigate = useNavigate();

  useEffect(() => {
    const startParam = webApp?.initDataUnsafe?.start_param;

    if (startParam) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ deep link
      switch (startParam) {
        case 'onboarding':
          navigate('/onboarding');
          break;
        case 'practice':
          navigate('/practice/cards');
          break;
        case 'premium':
          navigate('/profile/premium');
          break;
        default:
          navigate('/home');
      }
    }
  }, [webApp, navigate]);

  return <RouterProvider router={router} />;
}
```

#### –ò–∑ Mini App –≤ –±–æ—Ç

**–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É:**

```typescript
// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–±–æ—Ç –ø–æ–ª—É—á–∏—Ç —á–µ—Ä–µ–∑ sendData callback)
webApp.sendData(JSON.stringify({
  action: 'card_completed',
  cardId: 'uuid',
  rating: 'know'
}));

// –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–µ–∂–∏–º–µ inline –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
```

**–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:**

```typescript
// –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –±–æ—Ç–æ–º
webApp.openTelegramLink('https://t.me/your_bot?start=from_miniapp');
```

---

### 2.5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Telegram

#### –í–∞–ª–∏–¥–∞—Ü–∏—è initData

**–ö–†–ò–¢–ò–ß–ù–û!** –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø–∏—Å–∞–Ω –≤ `backend-auth.md`.

**–ö—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è:**
1. Frontend –ø–æ–ª—É—á–∞–µ—Ç `window.Telegram.WebApp.initData`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/api/auth/validate`
3. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
4. Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT token
5. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç JWT

**–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ:**
- `initDataUnsafe.user.id` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –≤ DevTools)
- Query parameters –≤ URL
- localStorage/cookies (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)

**–í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ:**
- initData —á–µ—Ä–µ–∑ HMAC-SHA256 –Ω–∞ backend
- JWT token –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

---

## 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Bot ‚Üî Mini App

### 3.1. –°—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤ –∏–∑ –¥–∏–∞–ª–æ–≥–∞

**–§–ª–æ—É:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—â–∞–µ—Ç—Å—è —Å –±–æ—Ç–æ–º –Ω–∞ –∏–∑—É—á–∞–µ–º–æ–º —è–∑—ã–∫–µ
2. LLM –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞"
4. –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ API
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å Mini App –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

**–ö–æ–¥ –≤ –±–æ—Ç–µ:**
```python
# –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ LLM
if llm_response.suggested_words:
    keyboard = [[
        InlineKeyboardButton(
            f"–î–æ–±–∞–≤–∏—Ç—å {len(llm_response.suggested_words)} —Å–ª–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏",
            callback_data=f"add_words:{','.join(llm_response.suggested_words)}"
        )
    ]]
    await update.message.reply_text(
        "–ù–∞—à–µ–ª –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –≤–∞—Å:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# Callback handler
elif callback_data.startswith("add_words:"):
    words = callback_data.split(":", 1)[1].split(",")
    created_cards = await create_cards_from_words(deck_id, words)

    keyboard = [[
        InlineKeyboardButton("–ò–∑—É—á–∏—Ç—å —Å–µ–π—á–∞—Å", web_app={"url": f"{MINI_APP_URL}?start=cards"})
    ]]
    await query.edit_message_text(
        f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {len(created_cards)} –∫–∞—Ä—Ç–æ—á–µ–∫!",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Å—Ç—Ä–∏–∫–µ

**–§–ª–æ—É:**
1. Scheduler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫—Ç–æ –Ω–µ –∑–∞–Ω–∏–º–∞–ª—Å—è —Å–µ–≥–æ–¥–Ω—è
2. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–∫—Ä—ã—Ç—å Mini App
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
4. –ü–æ—Å–ª–µ –ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∏–∫ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è

**–ö–æ–¥:**
```python
async def send_streak_reminder(user):
    keyboard = [[
        InlineKeyboardButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∏–∫ üî•", web_app={"url": MINI_APP_URL})
    ]]
    await bot.send_message(
        chat_id=user.telegram_id,
        text=f"üî• –£ –≤–∞—Å —Å—Ç—Ä–∏–∫ {user.streak} –¥–Ω–µ–π!\n"
             f"–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–µ–≥–æ–¥–Ω—è.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

---

## 4. Deployment

### 4.1. Environment Variables

```bash
# .env
BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
MINI_APP_URL=https://your-miniapp.com
BACKEND_DOMAIN=backend.external.osadchii.me
APP_ENV=production
```

### 4.2. Docker

```dockerfile
# Dockerfile –¥–ª—è –±–æ—Ç–∞
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY bot.py .
COPY handlers/ ./handlers/

CMD ["python", "bot.py"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  bot:
    build: ./bot
    env_file: .env
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  api:
    build: ./backend
    ports:
      - "8000:8000"
    env_file: .env
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: langbot
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

---

## 5. Best Practices

### 5.1. Error Handling

```python
async def handle_text_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        ...
    except UserNotFoundError:
        await update.message.reply_text("–í—ã–ø–æ–ª–Ω–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.")
    except RateLimitError:
        await update.message.reply_text("–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    except Exception as e:
        logger.error(f"Unexpected error: {e}", exc_info=True)
        await update.message.reply_text(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ @support"
        )
```

### 5.2. Rate Limiting

Telegram –∏–º–µ–µ—Ç —Å–≤–æ–∏ –ª–∏–º–∏—Ç—ã:
- 30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
- 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤
- 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥—É –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è:**
```python
import asyncio

async def send_bulk_messages(user_ids: list[int], text: str):
    for user_id in user_ids:
        try:
            await bot.send_message(user_id, text)
            await asyncio.sleep(0.05)  # 20 msg/sec
        except Exception as e:
            logger.error(f"Failed to send to {user_id}: {e}")
```

### 5.3. Logging

```python
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('bot.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# –í –∫–æ–¥–µ
logger.info(f"User {user.id} started conversation")
logger.warning(f"Rate limit exceeded for user {user.id}")
logger.error(f"Failed to process message: {e}", exc_info=True)
```

---

## –ß–µ–∫–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:**

- [ ] Bot token –ø–æ–ª—É—á–µ–Ω –æ—Ç @BotFather
- [ ] –ö–æ–º–∞–Ω–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ @BotFather
- [ ] Menu button –Ω–∞—Å—Ç—Ä–æ–µ–Ω (URL Mini App)
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω (production) –∏–ª–∏ polling (dev)
- [ ] Mini App URL –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] initData –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ backend
- [ ] Deep linking —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤)
- [ ] Error handling –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Logging –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Rate limiting —É—á—Ç–µ–Ω
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ callback –∫–Ω–æ–ø–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram Bot API –∏ Mini App –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–∏—è —è–∑—ã–∫–æ–≤ —Å –ò–ò-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º.
