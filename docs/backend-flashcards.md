# –°–∏—Å—Ç–µ–º–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ (Flashcards)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏

### –ü–æ–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
- –°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ –Ω–∞ –∏–∑—É—á–∞–µ–º–æ–º —è–∑—ã–∫–µ
- –ü–µ—Ä–µ–≤–æ–¥
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∫–∏ (—Ä–æ–¥, –ø–∞–¥–µ–∂, –≤—Ä–µ–º—è –∏ —Ç.–¥.)
- –¢–µ–≥–∏

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

### Spaced Repetition System (SRS)

**–í—ã–±–æ—Ä:** –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ SM-2 (SuperMemo 2)

**–ü—Ä–∏—á–∏–Ω—ã –≤—ã–±–æ—Ä–∞:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Anki, Duolingo)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–∞ ease factor (—Ñ–∞–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
- ‚úÖ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏
- ‚úÖ –•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —è–∑—ã–∫–æ–≤

**–û—Ç–ª–∏—á–∏—è –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ SM-2:**
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ease factor (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ª–µ–≥–∫–æ—Å—Ç–∏)
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤–º–µ—Å—Ç–æ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö
- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ 6)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–Ω–µ –≤—ã–±—Ä–∞–Ω—ã):**
- –ü–æ–ª–Ω—ã–π SM-2 - –∏–∑–±—ã—Ç–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
- Anki-–ø–æ–¥–æ–±–Ω—ã–π - —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
- Leitner System - –º–µ–Ω–µ–µ –≥–∏–±–∫–∏–π, —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –ø–æ–¥—Ö–æ–¥

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

#### –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫

**–¢—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ü–µ–Ω–∫–∏:**
1. **"–ó–Ω–∞—é"** (`know`) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å–ø–æ–º–Ω–∏–ª
2. **"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"** (`repeat`) - –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è
3. **"–ù–µ –∑–Ω–∞—é"** (`dont_know`) - –∑–∞–±—ã–ª, –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

#### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

**–î–ª—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (—Å—Ç–∞—Ç—É—Å `new`):**
```
interval = 0 (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É)
next_review = NOW()
```

**–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ—Ü–µ–Ω–∫–∏:**
```python
if rating == 'know':
    interval = 1 –¥–µ–Ω—å
    status = 'learning'
elif rating == 'repeat':
    interval = 0 (–ø–æ–∫–∞–∑–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç)
    status = 'new'
elif rating == 'dont_know':
    interval = 1 –¥–µ–Ω—å
    status = 'learning'
```

**–î–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Å—Ç–∞—Ç—É—Å–µ `learning` –∏–ª–∏ `review`:**
```python
if rating == 'know':
    new_interval = round(current_interval * 2.5)
    status = 'review' if new_interval >= 7 else 'learning'

elif rating == 'repeat':
    new_interval = current_interval  # –ù–µ –º–µ–Ω—è–µ—Ç—Å—è
    # –ü–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç

elif rating == 'dont_know':
    new_interval = 1  # –°–±—Ä–æ—Å –Ω–∞ 1 –¥–µ–Ω—å
    status = 'learning'
```

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö "–ó–Ω–∞—é":**
```
–ù–æ–≤–∞—è ‚Üí 1 –¥–µ–Ω—å ‚Üí 3 –¥–Ω—è ‚Üí 8 –¥–Ω–µ–π ‚Üí 20 –¥–Ω–µ–π ‚Üí 50 –¥–Ω–µ–π ‚Üí 125 –¥–Ω–µ–π ‚Üí 313 –¥–Ω–µ–π
```

#### –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞

**–ú–Ω–æ–∂–∏—Ç–µ–ª—å:** 2.5
- –ù–µ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π (–Ω–µ 3.0)
- –ù–µ —Å–ª–∏—à–∫–æ–º –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π (–Ω–µ 2.0)
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –Ω–∞–≥—Ä—É–∑–∫–æ–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º

**–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:**
```python
def calculate_next_interval(current_interval: int, rating: str) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.

    Args:
        current_interval: –¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö
        rating: –û—Ü–µ–Ω–∫–∞ ('know', 'repeat', 'dont_know')

    Returns:
        –ù–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö
    """
    if rating == 'dont_know':
        return 1
    elif rating == 'repeat':
        return current_interval
    else:  # 'know'
        if current_interval == 0:
            return 1
        return round(current_interval * 2.5)
```

#### –í—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

**–†–∞—Å—á–µ—Ç `next_review`:**
```python
from datetime import datetime, timedelta

def calculate_next_review(interval_days: int) -> datetime:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.

    Args:
        interval_days: –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö

    Returns:
        –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
    """
    return datetime.utcnow() + timedelta(days=interval_days)
```

**–î–ª—è "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å":**
- –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å", –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏
- `next_review = NOW() + 10 –º–∏–Ω—É—Ç`

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç–æ—á–µ–∫

**–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏:**
```python
def get_next_card(deck_id: str) -> Card | None:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏–∑ –∫–æ–ª–æ–¥—ã.

    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ (next_review <= NOW()) - –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–æ—Å—Ä–æ—á–∫–∏
    2. –ù–æ–≤—ã–µ (status = 'new')
    3. –ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
    """
    # 1. –ò—â–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    due_cards = query(Card).filter(
        Card.deck_id == deck_id,
        Card.next_review <= datetime.utcnow(),
        Card.deleted == False
    ).order_by(
        Card.next_review.asc()  # –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
    ).all()

    if due_cards:
        return due_cards[0]

    # 2. –ï—Å–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–µ—Ç - –±–µ—Ä–µ–º –Ω–æ–≤—ã–µ
    new_card = query(Card).filter(
        Card.deck_id == deck_id,
        Card.status == 'new',
        Card.deleted == False
    ).order_by(
        Card.created_at.asc()  # –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ
    ).first()

    return new_card
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º—É–º –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –¥–µ–Ω—å: –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç)
- –°–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –ø–æ–∫–∞ –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é

### –°—Ç–∞—Ç—É—Å—ã –∫–∞—Ä—Ç–æ—á–µ–∫

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–∞—Ä—Ç–æ—á–∫–∏:**

#### 1. `new` - –ù–æ–≤–∞—è
- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∞
- –ù–∏ —Ä–∞–∑—É –Ω–µ –∏–∑—É—á–∞–ª–∞—Å—å
- `interval_days = 0`
- `next_review = NOW()`
- `reviews_count = 0`

**–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- –ü–æ—Å–ª–µ –ª—é–±–æ–π –ø–µ—Ä–≤–æ–π –æ—Ü–µ–Ω–∫–∏ ‚Üí `learning`

#### 2. `learning` - –ò–∑—É—á–∞–µ—Ç—Å—è
- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑—É—á–µ–Ω–∏—è
- –ò–Ω—Ç–µ—Ä–≤–∞–ª < 7 –¥–Ω–µ–π
- `interval_days = 1-6`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∑–∞–∫—Ä–µ–ø–∏–ª –º–∞—Ç–µ—Ä–∏–∞–ª

**–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- –ü–æ—Å–ª–µ "–ó–Ω–∞—é" —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º ‚â• 7 –¥–Ω–µ–π ‚Üí `review`
- –ü–æ—Å–ª–µ "–ù–µ –∑–Ω–∞—é" ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è `learning` (—Å–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞)

#### 3. `review` - –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ ‚â• 7 –¥–Ω–µ–π
- –ú–∞—Ç–µ—Ä–∏–∞–ª –∑–∞–∫—Ä–µ–ø–ª–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
- `interval_days >= 7`

**–í–æ–∑–≤—Ä–∞—Ç –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- –ü–æ—Å–ª–µ "–ù–µ –∑–Ω–∞—é" ‚Üí `learning` (–∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 1 –¥–µ–Ω—å)

**–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   new   ‚îÇ
‚îÇ  (0 –¥)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ –õ—é–±–∞—è –æ—Ü–µ–Ω–∫–∞
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ learning ‚îÇ  ‚óÑ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ (1-6 –¥)  ‚îÇ      ‚îÇ "–ù–µ –∑–Ω–∞—é"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
     ‚îÇ "–ó–Ω–∞—é"     ‚îÇ
     ‚îÇ (‚â•7 –¥–Ω–µ–π)  ‚îÇ
     ‚ñº            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  review  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ (7+ –¥–Ω)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:**
–î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–¥—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:
- `new_cards_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
- `due_cards_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è)

#### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –°—Ç–∞—Ç—É—Å "–£—Å–≤–æ–µ–Ω–∞" (mastered) –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—Å–µ–≥–¥–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ `review`
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –¥–æ–ª–≥–∏—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å > 1 –≥–æ–¥–∞)

## –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ

#### –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã:**
1. –Ø–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "–î–æ–±–∞–≤—å —Å–ª–æ–≤–æ casa –≤ –∫–∞—Ä—Ç–æ—á–∫–∏"
2. –ù–µ—è–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "–ß—Ç–æ –∑–Ω–∞—á–∏—Ç casa?" ‚Üí –∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∏" –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º
3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ: "–î–æ–±–∞–≤—å –≤—Ä–µ–º–µ–Ω–∞ –≥–æ–¥–∞" ‚Üí —Å–æ–∑–¥–∞–µ—Ç 4 –∫–∞—Ä—Ç–æ—á–∫–∏ (–ª–µ—Ç–æ, –∑–∏–º–∞, –æ—Å–µ–Ω—å, –≤–µ—Å–Ω–∞)

**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM:**

#### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
```python
async def detect_add_card_intent(user_message: str) -> Intent:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É.

    –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:
    - "–¥–æ–±–∞–≤—å", "—Å–æ–∑–¥–∞–π", "—Å–æ—Ö—Ä–∞–Ω–∏"
    - "–≤ –∫–∞—Ä—Ç–æ—á–∫–∏", "–≤ –∫–æ–ª–æ–¥—É"
    - "–∑–∞–ø–æ–º–Ω–∏", "–≤—ã—É—á–∏—Ç—å"
    """
    prompt = f"""
    Analyze the user's message and determine if they want to add a word to flashcards.

    Message: "{user_message}"

    Return JSON:
    {{
      "intent": "add_card",  // or "other"
      "words": ["casa"],  // list of words to add
      "deck_name": null,  // or specific deck name
      "confidence": 0.95
    }}
    """

    response = await llm_service.chat(messages=[
        {'role': 'user', 'content': prompt}
    ], response_format={'type': 'json_object'})

    return Intent.parse_obj(json.loads(response))
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
async def check_duplicate(
    word: str,
    deck_id: str,
    language: str
) -> tuple[bool, Card | None]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å —Ç–∞–∫–æ–π –ª–µ–º–º–æ–π.

    –≠—Ç–∞–ø—ã:
    1. –ü–æ–ª—É—á–∏—Ç—å –ª–µ–º–º—É —á–µ—Ä–µ–∑ LLM
    2. –ü–æ–∏—Å–∫ –≤ –ë–î –ø–æ lemma (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
    3. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    """
    # 1. –ü–æ–ª—É—á–∞–µ–º –ª–µ–º–º—É (–Ω–∞—á–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É)
    lemma = await llm_service.get_lemma(word, language)

    # 2. –ò—â–µ–º –≤ –ë–î
    existing_card = await db.query(Card).filter(
        Card.deck_id == deck_id,
        func.lower(Card.lemma) == lemma.lower(),
        Card.deleted == False
    ).first()

    return (existing_card is not None, existing_card)
```

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–µ–º–º—ã —á–µ—Ä–µ–∑ LLM:**
```python
# –ü—Ä–æ–º–ø—Ç: prompts/utils/get_lemma.txt
prompt = f"""
Determine the lemma (base form) of the word: "{word}" in {language}.

The lemma is:
- For nouns: singular form (with article if language requires)
- For verbs: infinitive
- For adjectives: masculine singular (if applicable)

Examples:
- Spanish: "casas" ‚Üí "casa", "com√≠" ‚Üí "comer"
- German: "H√§user" ‚Üí "das Haus", "gehst" ‚Üí "gehen"
- English: "houses" ‚Üí "house", "went" ‚Üí "go"

Respond with only the lemma, no explanation.
"""
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –î–ª—è —è–∑—ã–∫–æ–≤ —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏ (–Ω–µ–º–µ—Ü–∫–∏–π, –≥—Ä–µ—á–µ—Å–∫–∏–π) –ª–µ–º–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –∞—Ä—Ç–∏–∫–ª—å
- –ò—Å–ø–∞–Ω—Å–∫–∏–π: "casa" (–±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è)
- –ù–µ–º–µ—Ü–∫–∏–π: "das Haus" (—Å –∞—Ä—Ç–∏–∫–ª–µ–º)
- –ì—Ä–µ—á–µ—Å–∫–∏–π: "œÑŒø œÉœÄŒØœÑŒπ" (—Å –∞—Ä—Ç–∏–∫–ª–µ–º)

#### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ä—Ç–æ—á–∫–∏

**–í—ã–∑–æ–≤ LLM:**
```python
async def generate_card_content(
    word: str,
    profile: LanguageProfile,
    context: str | None = None
) -> CardContent:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ LLM.

    Args:
        word: –°–ª–æ–≤–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        profile: –Ø–∑—ã–∫–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        CardContent —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º, –ø—Ä–∏–º–µ—Ä–æ–º –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π
    """
    prompt = render_prompt('cards/generate_card.txt', {
        'word': word,
        'language': profile.language,
        'level': profile.current_level,
        'goals': profile.goals,
        'context': context
    })

    response = await llm_service.chat(
        messages=[
            {'role': 'system', 'content': get_system_prompt(profile)},
            {'role': 'user', 'content': prompt}
        ],
        response_format={'type': 'json_object'},
        temperature=0.7
    )

    return CardContent.parse_obj(json.loads(response))
```

**–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (`prompts/cards/generate_card.txt`):**
```jinja2
Generate a flashcard for the word: "{{ word }}"

Requirements:
1. Provide the word in its base form (lemma)
2. Translate to Russian
3. Create an example sentence in {{ language }} (appropriate for {{ level }} level)
4. Translate the example to Russian

Consider:
- User's level: {{ level }}
- User's goals: {{ goals | join(', ') }}
- The example should be practical and memorable
{% if context %}
- Context from conversation: {{ context }}
{% endif %}

Respond in JSON format:
{
  "word": "casa",
  "lemma": "casa",
  "translation": "–¥–æ–º",
  "example": "Mi casa es tu casa",
  "example_translation": "–ú–æ–π –¥–æ–º - —Ç–≤–æ–π –¥–æ–º",
  "notes": "common expression meaning 'make yourself at home'"
}
```

**–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å:**
- **A1-A2:** –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –±–∞–∑–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞
  - "La casa es grande" (–î–æ–º –±–æ–ª—å—à–æ–π)
- **B1-B2:** –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  - "Compr√© una casa el a√±o pasado" (–Ø –∫—É–ø–∏–ª –¥–æ–º –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É)
- **C1-C2:** –ò–¥–∏–æ–º—ã, —Å–ª–æ–∂–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞
  - "Mi casa es tu casa" (–ú–æ–π –¥–æ–º - —Ç–≤–æ–π –¥–æ–º)

#### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏

**–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥:**
```python
async def create_card(
    word: str,
    deck_id: str,
    profile_id: str,
    user_id: str
) -> Card:
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø–æ–ª–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–≤–µ—Ä–æ–∫.

    –≠—Ç–∞–ø—ã:
    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–µ—Ä–µ–∑ LLM
    4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∫–æ–ª–æ–¥—ã
    """
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
    user = await get_user(user_id)
    if not user.is_premium:
        cards_count = await count_user_cards(user_id)
        if cards_count >= 200:
            raise LimitReachedError("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (200)")

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    profile = await get_profile(profile_id)
    is_duplicate, existing = await check_duplicate(
        word, deck_id, profile.language
    )

    if is_duplicate:
        raise DuplicateCardError(f"–ö–∞—Ä—Ç–æ—á–∫–∞ '{existing.word}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    content = await generate_card_content(word, profile)

    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    card = Card(
        id=uuid4(),
        deck_id=deck_id,
        word=content.word,
        translation=content.translation,
        example=content.example,
        example_translation=content.example_translation,
        lemma=content.lemma,
        notes=content.notes,
        status='new',
        interval_days=0,
        next_review=datetime.utcnow(),
        reviews_count=0,
        created_at=datetime.utcnow()
    )

    await db.add(card)
    await db.commit()

    # 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ (—á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä)
    # –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏—Ç deck.cards_count –∏ deck.new_cards_count

    return card
```

#### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ

**–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤:**
```python
async def create_cards_batch(
    words: list[str],
    deck_id: str,
    profile_id: str,
    user_id: str
) -> BatchResult:
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å.

    –ú–∞–∫—Å–∏–º—É–º: 20 —Å–ª–æ–≤ –∑–∞ —Ä–∞–∑

    Returns:
        BatchResult —Å —Å–ø–∏—Å–∫–∞–º–∏ created, duplicates, failed
    """
    if len(words) > 20:
        raise ValidationError("–ú–∞–∫—Å–∏–º—É–º 20 —Å–ª–æ–≤ –∑–∞ —Ä–∞–∑")

    results = BatchResult(created=[], duplicates=[], failed=[])

    for word in words:
        try:
            card = await create_card(word, deck_id, profile_id, user_id)
            results.created.append(card)
        except DuplicateCardError as e:
            results.duplicates.append({'word': word, 'error': str(e)})
        except Exception as e:
            results.failed.append({'word': word, 'error': str(e)})
            logger.error(f"Failed to create card for '{word}': {e}")

    return results
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

#### OCR (Optical Character Recognition)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- **Tesseract OCR** - –±—ã—Å—Ç—Ä–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (–ø–µ—Ä–≤–∏—á–Ω–æ–µ)
- **GPT-4 Vision** - —É–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ (fallback)

> –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `app/services/media.py` (OCRService), REST `POST /api/media/ocr` –∏ Telegram-—Ö–µ–Ω–¥–ª–µ—Ä–µ —Ñ–æ—Ç–æ (`TelegramBot._handle_photo_message`).

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏:**
- –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∏—Å–ø–∞–Ω—Å–∫–∏–π, –Ω–µ–º–µ—Ü–∫–∏–π, —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π, –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π)
- –ö–∏—Ç–∞–π—Å–∫–∏–π, —è–ø–æ–Ω—Å–∫–∏–π, –∫–æ—Ä–µ–π—Å–∫–∏–π
- –ê—Ä–∞–±—Å–∫–∏–π

#### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

**1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç Telegram:**
```python
async def handle_photo_message(
    update: Update,
    context: CallbackContext
):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # –ü–æ–ª—É—á–∞–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    photo = update.message.photo[-1]

    # –°–∫–∞—á–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ
    file = await context.bot.get_file(photo.file_id)
    image_bytes = await file.download_as_bytearray()

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
    result = await process_image_text(
        image_bytes,
        language=profile.language,
        user_id=user.id
    )

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (file —É–¥–∞–ª—è–µ—Ç—Å—è —Å–±–æ—Ä—â–∏–∫–æ–º –º—É—Å–æ—Ä–∞)

    return result
```

**2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:**
```python
async def process_image_text(
    image_bytes: bytes,
    language: str,
    user_id: str
) -> OCRResult:
    """
    –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ë—ã—Å—Ç—Ä—ã–π OCR —á–µ—Ä–µ–∑ Tesseract
    2. –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª–æ—Ö–æ–π - fallback –Ω–∞ GPT-4 Vision
    3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ —è–∑—ã–∫—É
    4. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    """
    # 1. Tesseract OCR
    tesseract_text = await extract_text_tesseract(image_bytes, language)

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
    if len(tesseract_text) > 50 and is_readable(tesseract_text):
        logger.info("Tesseract OCR successful")
        recognized_text = tesseract_text
    else:
        # Fallback –Ω–∞ GPT-4 Vision
        logger.info("Falling back to GPT-4 Vision")
        image_url = await upload_temp_image(image_bytes, user_id)
        recognized_text = await extract_text_vision(image_url, language)
        await cleanup_temp_image(image_url)

    # 3. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —è–∑—ã–∫—É (–µ—Å–ª–∏ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    filtered_text = filter_text_by_language(recognized_text, language)

    return OCRResult(
        text=filtered_text,
        confidence='high' if len(filtered_text) > 50 else 'low',
        method='tesseract' if tesseract_text else 'gpt4_vision'
    )

def extract_text_tesseract(
    image_bytes: bytes,
    language: str
) -> str:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ Tesseract OCR.
    """
    import pytesseract
    from PIL import Image
    import io

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    image = Image.open(io.BytesIO(image_bytes))

    # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ grayscale
    # - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
    # - –£–¥–∞–ª–µ–Ω–∏–µ —à—É–º–æ–≤

    # –ú–∞–ø–∏–º —è–∑—ã–∫ –Ω–∞ Tesseract –∫–æ–¥
    lang_map = {
        'es': 'spa',
        'en': 'eng',
        'de': 'deu',
        'fr': 'fra',
        'it': 'ita',
        'ru': 'rus',
        'zh': 'chi_sim',
        'ja': 'jpn',
        'ko': 'kor',
        'ar': 'ara'
    }

    tesseract_lang = lang_map.get(language, 'eng')

    # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º
    text = pytesseract.image_to_string(image, lang=tesseract_lang)

    return text.strip()

async def extract_text_vision(
    image_url: str,
    language: str
) -> str:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ GPT-4 Vision API.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback –¥–ª—è –ø–ª–æ—Ö–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
    """
    response = await llm_service.extract_text_from_image(
        image_url,
        language
    )

    return response.strip()
```

**3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ª–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```python
async def suggest_words_from_text(
    text: str,
    profile: LanguageProfile,
    existing_lemmas: list[str]
) -> list[WordSuggestion]:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ª–æ–≤–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∏.

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞:
    - –ß–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å –≤ —è–∑—ã–∫–µ
    - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Ä–æ–≤–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å –¥–ª—è —Ü–µ–ª–µ–π –æ–±—É—á–µ–Ω–∏—è
    - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö

    –ú–∞–∫—Å–∏–º—É–º: 10 —Å–ª–æ–≤
    """
    prompt = render_prompt('cards/suggest_words.txt', {
        'text': text,
        'language': profile.language,
        'level': profile.current_level,
        'goals': profile.goals,
        'existing_lemmas': existing_lemmas[:50]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    })

    response = await llm_service.chat(
        messages=[
            {'role': 'system', 'content': get_system_prompt(profile)},
            {'role': 'user', 'content': prompt}
        ],
        response_format={'type': 'json_object'},
        temperature=0.8
    )

    suggestions = json.loads(response)['suggestions']

    return [WordSuggestion(**s) for s in suggestions[:10]]
```

**4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –±–æ—Ç–µ:**
```python
async def send_ocr_result_with_suggestions(
    update: Update,
    ocr_result: OCRResult,
    suggestions: list[WordSuggestion]
):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤.
    """
    message = f"üìÑ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n\n{ocr_result.text}\n\n"

    if suggestions:
        message += "üí° –ü—Ä–µ–¥–ª–∞–≥–∞—é –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∏:"

    # –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞
    keyboard = []
    for suggestion in suggestions:
        keyboard.append([
            InlineKeyboardButton(
                text=f"‚ûï {suggestion.word}",
                callback_data=f"add_card:{suggestion.word}"
            )
        ])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        message,
        reply_markup=reply_markup,
        parse_mode='HTML'
    )
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –≥–æ–ª–æ—Å–∞

#### Speech-to-Text (STT)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** OpenAI Whisper API

> –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `app/services/speech_to_text.py` + —Ö–µ–Ω–¥–ª–µ—Ä `TelegramBot._handle_voice_message`. –õ–∏–º–∏—Ç—ã –Ω–∞ –¥–ª–∏–Ω—É/—Ä–∞–∑–º–µ—Ä –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `VOICE_*` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏:** 50+ —è–∑—ã–∫–æ–≤ —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 2 –º–∏–Ω—É—Ç—ã (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram)
- –§–æ—Ä–º–∞—Ç: OGG (Telegram voice messages)
- –ö–∞—á–µ—Å—Ç–≤–æ: –≤—ã—Å–æ–∫–æ–µ (–º–æ–¥–µ–ª—å large-v3)

#### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

**1. –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
async def handle_voice_message(
    update: Update,
    context: CallbackContext
):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    voice = update.message.voice

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∞–∫—Å 2 –º–∏–Ω—É—Ç—ã = 120 —Å–µ–∫—É–Ω–¥)
    if voice.duration > 120:
        await update.message.reply_text(
            "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. "
            "–ú–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ."
        )
        return

    # –°–∫–∞—á–∏–≤–∞–µ–º
    file = await context.bot.get_file(voice.file_id)
    audio_bytes = await file.download_as_bytearray()

    # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º
    transcript, detected_language = await transcribe_voice(
        audio_bytes,
        expected_language=profile.language
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —è–∑—ã–∫–∞
    if detected_language != profile.language:
        await update.message.reply_text(
            f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω —è–∑—ã–∫: {detected_language}, "
            f"–æ–∂–∏–¥–∞–ª—Å—è: {profile.language}\n\n"
            f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {transcript}"
        )
    else:
        await update.message.reply_text(
            f"üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {transcript}"
        )

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await process_user_message(
        user=user,
        profile=profile,
        message=transcript,
        source='voice'
    )
```

**2. –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Whisper:**
```python
async def transcribe_voice(
    audio_bytes: bytes,
    expected_language: str | None = None
) -> tuple[str, str]:
    """
    –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Whisper API.

    Args:
        audio_bytes: –ê—É–¥–∏–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OGG
        expected_language: –û–∂–∏–¥–∞–µ–º—ã–π —è–∑—ã–∫ (ISO 639-1)

    Returns:
        (transcript, detected_language)
    """
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (Whisper —Ç—Ä–µ–±—É–µ—Ç file-like object)
    with tempfile.NamedTemporaryFile(suffix='.ogg', delete=False) as temp_file:
        temp_file.write(audio_bytes)
        temp_file_path = temp_file.name

    try:
        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º
        with open(temp_file_path, 'rb') as audio:
            response = await openai_client.audio.transcriptions.create(
                model="whisper-1",
                file=audio,
                language=expected_language,  # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è Whisper
                response_format="verbose_json"  # –í–∫–ª—é—á–∞–µ—Ç detected_language
            )

        transcript = response.text
        detected_language = response.language

        logger.info(
            f"Transcribed {len(transcript)} chars, "
            f"language: {detected_language}"
        )

        return transcript, detected_language

    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        os.unlink(temp_file_path)
```

**3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**

–ü–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –æ–±—Ä–∞–∑–æ–º:
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞–º–µ—Ä–µ–Ω–∏–µ ("–¥–æ–±–∞–≤—å —Å–ª–æ–≤–æ X")
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–µ—Ä–µ–∑ LLM
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ú–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å: "–î–æ–±–∞–≤—å —Å–ª–æ–≤–æ casa –≤ –∫–∞—Ä—Ç–æ—á–∫–∏"
- –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∞—Ç—å —Å–ª–æ–≤–æ: "casa" ‚Üí –±–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç, —á—Ç–æ —Å –Ω–∏–º –¥–µ–ª–∞—Ç—å

### –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ

#### –ß–µ—Ä–µ–∑ Mini App

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:**

**1. –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```typescript
interface CardCreationForm {
  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  words: string[];  // –û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤

  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  deck_id?: string;  // –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ - –∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–ª–æ–¥–∞

  // –§–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞:
  // - –û–¥–Ω–æ —Å–ª–æ–≤–æ: "casa"
  // - –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: "casa, perro, gato"
  // - –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏:
  //   casa
  //   perro
  //   gato
}
```

**2. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
```tsx
// components/AddCardForm.tsx
const AddCardForm: React.FC = () => {
  const [words, setWords] = useState<string>('');
  const [deckId, setDeckId] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    setLoading(true);

    // –ü–∞—Ä—Å–∏–º —Å–ª–æ–≤–∞
    const wordsList = parseWordsList(words);

    try {
      const result = await api.cards.createBatch({
        deck_id: deckId || activeDec–∫Id,
        words: wordsList
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${result.created.length}`);

      if (result.duplicates.length > 0) {
        showWarning(`‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç—ã: ${result.duplicates.length}`);
      }

      if (result.failed.length > 0) {
        showError(`‚ùå –û—à–∏–±–∫–∏: ${result.failed.length}`);
      }

      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      setWords('');

    } catch (error) {
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <textarea
        value={words}
        onChange={(e) => setWords(e.target.value)}
        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)"
        rows={5}
      />

      <select
        value={deckId || ''}
        onChange={(e) => setDeckId(e.target.value || null)}
      >
        <option value="">–ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–ª–æ–¥–∞</option>
        {decks.map(deck => (
          <option key={deck.id} value={deck.id}>
            {deck.name}
          </option>
        ))}
      </select>

      <button type="submit" disabled={loading || !words.trim()}>
        {loading ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–∏—Ç—å'}
      </button>
    </form>
  );
};

function parseWordsList(input: string): string[] {
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
  // 1. –ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: "casa, perro, gato"
  // 2. –° –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏:
  //    casa
  //    perro
  //    gato

  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
  let words = input.split('\n').map(w => w.trim()).filter(Boolean);

  // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ - –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –∑–∞–ø—è—Ç–æ–π
  if (words.length === 1 && words[0].includes(',')) {
    words = words[0].split(',').map(w => w.trim()).filter(Boolean);
  }

  return words;
}
```

**3. Batch —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```tsx
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ batch —Å–æ–∑–¥–∞–Ω–∏—è
const BatchResultView: React.FC<{ result: BatchResult }> = ({ result }) => {
  return (
    <div className="batch-result">
      {result.created.length > 0 && (
        <div className="success">
          <h4>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {result.created.length}</h4>
          <ul>
            {result.created.map(card => (
              <li key={card.id}>
                {card.word} - {card.translation}
              </li>
            ))}
          </ul>
        </div>
      )}

      {result.duplicates.length > 0 && (
        <div className="warning">
          <h4>‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç—ã: {result.duplicates.length}</h4>
          <ul>
            {result.duplicates.map((dup, i) => (
              <li key={i}>
                {dup.word}: {dup.error}
              </li>
            ))}
          </ul>
        </div>
      )}

      {result.failed.length > 0 && (
        <div className="error">
          <h4>‚ùå –û—à–∏–±–∫–∏: {result.failed.length}</h4>
          <ul>
            {result.failed.map((fail, i) => (
              <li key={i}>
                {fail.word}: {fail.error}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};
```

#### –ß–µ—Ä–µ–∑ –±–æ—Ç

**–ö–æ–º–∞–Ω–¥–∞ `/add_card`:**
```python
async def add_card_command(update: Update, context: CallbackContext):
    """
    –ö–æ–º–∞–Ω–¥–∞ /add_card –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    /add_card casa
    /add_card casa perro gato
    """
    if not context.args:
        await update.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_card <—Å–ª–æ–≤–æ1> [—Å–ª–æ–≤–æ2] ...\n"
            "–ü—Ä–∏–º–µ—Ä: /add_card casa\n"
            "–ò–ª–∏: /add_card casa perro gato"
        )
        return

    words = context.args
    user = await get_user(update.effective_user.id)
    profile = await get_active_profile(user.id)
    active_deck = await get_active_deck(profile.id)

    # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
    result = await create_cards_batch(
        words=words,
        deck_id=active_deck.id,
        profile_id=profile.id,
        user_id=user.id
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    message = ""

    if result.created:
        message += f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫: {len(result.created)}\n\n"
        for card in result.created:
            message += f"üìù {card.word} - {card.translation}\n"
            message += f"   üí¨ {card.example}\n\n"

    if result.duplicates:
        message += f"‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç—ã ({len(result.duplicates)}):\n"
        for dup in result.duplicates:
            message += f"   ‚Ä¢ {dup['word']}\n"

    if result.failed:
        message += f"‚ùå –û—à–∏–±–∫–∏ ({len(result.failed)}):\n"
        for fail in result.failed:
            message += f"   ‚Ä¢ {fail['word']}: {fail['error']}\n"

    await update.message.reply_text(message)
```

## –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫

### –ö–æ–ª–æ–¥—ã (Decks)

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ö–æ–ª–æ–¥–∞ (Deck)** - —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ —Ç–µ–º–µ, —É—Ä–æ–≤–Ω—é –∏–ª–∏ —Ü–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –∫–∞–∫ –º–∏–Ω–∏–º—É–º 1 –∫–æ–ª–æ–¥—É
- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π –∫–æ–ª–æ–¥–µ
- –û–¥–Ω–∞ –∫–æ–ª–æ–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
- –ö–æ–ª–æ–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ª–∏—á–Ω—ã–º–∏ –∏–ª–∏ –≥—Ä—É–ø–ø–æ–≤—ã–º–∏ (shared)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–æ–¥—ã

```python
class Deck:
    id: UUID
    profile_id: UUID  # –ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ —è–∑—ã–∫–æ–≤–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é
    name: str  # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã
    description: str | None  # –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    is_active: bool  # –ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–ª–æ–¥–∞
    is_group: bool  # –ì—Ä—É–ø–ø–æ–≤–∞—è –∫–æ–ª–æ–¥–∞ (–∏–∑ –≥—Ä—É–ø–ø—ã)
    owner_id: UUID | None  # –í–ª–∞–¥–µ–ª–µ—Ü (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö)
    cards_count: int  # –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫
    new_cards_count: int  # –ù–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    due_cards_count: int  # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    created_at: datetime
    updated_at: datetime
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:**
```python
async def create_profile(
    user_id: str,
    language: str,
    current_level: str,
    ...
) -> LanguageProfile:
    """
    –°–æ–∑–¥–∞–µ—Ç —è–∑—ã–∫–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–ª–æ–¥–æ–π.
    """
    # 1. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    profile = LanguageProfile(
        id=uuid4(),
        user_id=user_id,
        language=language,
        current_level=current_level,
        ...
    )

    await db.add(profile)

    # 2. –°–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–ª–æ–¥—É
    default_deck = Deck(
        id=uuid4(),
        profile_id=profile.id,
        name=f"–ú–æ–∏ —Å–ª–æ–≤–∞ ({language_name})",
        is_active=True,
        is_group=False,
        cards_count=0,
        new_cards_count=0,
        due_cards_count=0,
        created_at=datetime.utcnow()
    )

    await db.add(default_deck)
    await db.commit()

    return profile
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–¥–∞–º–∏

**–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–æ–¥—ã:**
```python
async def create_deck(
    profile_id: str,
    name: str,
    description: str | None = None
) -> Deck:
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∫–æ–ª–æ–¥—É –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è.
    """
    deck = Deck(
        id=uuid4(),
        profile_id=profile_id,
        name=name,
        description=description,
        is_active=False,  # –ù–µ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        is_group=False,
        cards_count=0,
        new_cards_count=0,
        due_cards_count=0,
        created_at=datetime.utcnow()
    )

    await db.add(deck)
    await db.commit()

    return deck
```

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–ª–æ–¥—ã:**
```python
async def activate_deck(deck_id: str, profile_id: str):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–ª–æ–¥—É –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é.
    –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–ª–æ–¥—É.
    """
    # 1. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–ª–æ–¥—ã –ø—Ä–æ—Ñ–∏–ª—è
    await db.execute(
        update(Deck)
        .where(Deck.profile_id == profile_id)
        .values(is_active=False)
    )

    # 2. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
    await db.execute(
        update(Deck)
        .where(Deck.id == deck_id)
        .values(is_active=True)
    )

    await db.commit()
```

**–ü—Ä–∏–º–µ—Ä—ã –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:**
- **–ü–æ —Ç–µ–º–µ:** "–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–†–∞–±–æ—Ç–∞"
- **–ü–æ —É—Ä–æ–≤–Ω—é:** "A1-A2", "B1-B2", "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π"
- **–ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É:** "–ò–∑ —É—á–µ–±–Ω–∏–∫–∞", "–ò–∑ —Ñ–∏–ª—å–º–æ–≤", "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã"
- **–ü–æ —á–∞—Å—Ç–æ—Ç–µ:** "–¢–æ–ø 1000", "–†–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞"

#### –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–¥—ã

**Soft delete:**
```python
async def delete_deck(deck_id: str, profile_id: str):
    """
    –£–¥–∞–ª—è–µ—Ç –∫–æ–ª–æ–¥—É (soft delete).

    –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
    - –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –∫–æ–ª–æ–¥—É
    - –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤—É—é –∫–æ–ª–æ–¥—É
    """
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–ª–æ–¥–∞
    decks_count = await db.query(Deck).filter(
        Deck.profile_id == profile_id,
        Deck.deleted == False
    ).count()

    if decks_count <= 1:
        raise BusinessLogicError("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–ª–æ–¥—É")

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –≥—Ä—É–ø–ø–æ–≤–∞—è –∫–æ–ª–æ–¥–∞
    deck = await db.query(Deck).filter(Deck.id == deck_id).first()

    if deck.is_group:
        raise BusinessLogicError("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤—É—é –∫–æ–ª–æ–¥—É")

    # 3. Soft delete –∫–æ–ª–æ–¥—ã –∏ –≤—Å–µ—Ö –µ–µ –∫–∞—Ä—Ç–æ—á–µ–∫
    await db.execute(
        update(Deck)
        .where(Deck.id == deck_id)
        .values(deleted=True, deleted_at=datetime.utcnow())
    )

    await db.execute(
        update(Card)
        .where(Card.deck_id == deck_id)
        .values(deleted=True, deleted_at=datetime.utcnow())
    )

    await db.commit()

    # 4. –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–Ω–∞—è –∫–æ–ª–æ–¥–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
    if deck.is_active:
        first_deck = await db.query(Deck).filter(
            Deck.profile_id == profile_id,
            Deck.deleted == False
        ).first()

        if first_deck:
            await activate_deck(first_deck.id, profile_id)
```

### –¢–µ–≥–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

#### –°–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤ (–ë—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (MVP) —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ–ª–æ–¥—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏.

**–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –ë—É–¥—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø–æ—Å–ª–µ MVP)
class Tag:
    id: UUID
    profile_id: UUID
    name: str  # –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞
    color: str | None  # –¶–≤–µ—Ç (hex)
    created_at: datetime

class CardTag:
    card_id: UUID
    tag_id: UUID
    created_at: datetime
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤:**
- –ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: `#–≥–ª–∞–≥–æ–ª`, `#—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ`, `#–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ`
- –¢–µ–º–∞—Ç–∏–∫–∞: `#–µ–¥–∞`, `#–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è`, `#—Ä–∞–±–æ—Ç–∞`
- –°–ª–æ–∂–Ω–æ—Å—Ç—å: `#—Å–ª–æ–∂–Ω–æ–µ`, `#–ª–µ–≥–∫–æ–µ`, `#–ø—É—Ç–∞—é—Å—å`
- –ò—Å—Ç–æ—á–Ω–∏–∫: `#–∏–∑_—Ñ–∏–ª—å–º–∞`, `#–∏–∑_–∫–Ω–∏–≥–∏`, `#–æ—Ç_–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è`

#### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫

**–¢–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã (MVP):**

**1. –ü–æ –∫–æ–ª–æ–¥–µ:**
```python
GET /api/cards?deck_id=<uuid>
```

**2. –ü–æ —Å—Ç–∞—Ç—É—Å—É:**
```python
GET /api/cards?deck_id=<uuid>&status=new
GET /api/cards?deck_id=<uuid>&status=learning
GET /api/cards?deck_id=<uuid>&status=review
```

**3. –ü–æ –ø–æ–∏—Å–∫—É:**
```python
GET /api/cards?deck_id=<uuid>&search=casa
# –ü–æ–∏—Å–∫ –ø–æ word, translation, example
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞:**
```python
async def search_cards(
    deck_id: str,
    search_query: str,
    limit: int = 20,
    offset: int = 0
) -> list[Card]:
    """
    –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ —Å–ª–æ–≤—É, –ø–µ—Ä–µ–≤–æ–¥—É –∏–ª–∏ –ø—Ä–∏–º–µ—Ä—É.
    """
    query = db.query(Card).filter(
        Card.deck_id == deck_id,
        Card.deleted == False,
        or_(
            Card.word.ilike(f'%{search_query}%'),
            Card.translation.ilike(f'%{search_query}%'),
            Card.example.ilike(f'%{search_query}%')
        )
    ).order_by(
        Card.created_at.desc()
    ).limit(limit).offset(offset)

    return await query.all()
```

### –®–∞—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –≥—Ä—É–ø–ø–∞—Ö

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –≥—Ä—É–ø–ø

**–ì—Ä—É–ø–ø–∞** - —ç—Ç–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª—è—Ç—Å—è —É—á–µ–±–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ (–∫–æ–ª–æ–¥–∞–º–∏ –∏ —Ç–µ–º–∞–º–∏).

**–†–æ–ª–∏ –≤ –≥—Ä—É–ø–ø–µ:**
- **Owner** (–≤–ª–∞–¥–µ–ª–µ—Ü) - —Å–æ–∑–¥–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø—ã, –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
- **Member** (—É—á–∞—Å—Ç–Ω–∏–∫) - –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

#### –ì—Ä—É–ø–ø–æ–≤—ã–µ –∫–æ–ª–æ–¥—ã

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –í–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ª–æ–¥—É (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é)
2. –í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–¥—É –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã
3. –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –∫–æ–ª–æ–¥–µ
4. –ì—Ä—É–ø–ø–æ–≤–∞—è –∫–æ–ª–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–æ–ª–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å –ø–æ–º–µ—Ç–∫–æ–π `is_group=true`)
5. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –∏–∑—É—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–π –∫–æ–ª–æ–¥—ã, –Ω–æ –Ω–µ –º–æ–≥—É—Ç –∏—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–¥—ã –≤ –≥—Ä—É–ø–ø—É:**
```python
async def share_deck_to_group(
    deck_id: str,
    group_id: str,
    owner_id: str
):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–¥—É –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã.

    –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã.
    """
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã)
    group = await db.query(Group).filter(Group.id == group_id).first()

    if group.owner_id != owner_id:
        raise PermissionError("–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã")

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–ª–æ–¥–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–ª–∞–¥–µ–ª—å—Ü—É
    deck = await db.query(Deck).filter(Deck.id == deck_id).first()

    if deck.profile_id not in await get_user_profiles(owner_id):
        raise PermissionError("–ö–æ–ª–æ–¥–∞ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–ª–∞–¥–µ–ª—å—Ü—É")

    # 3. –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑—å –≥—Ä—É–ø–ø–∞-–∫–æ–ª–æ–¥–∞
    group_material = GroupMaterial(
        id=uuid4(),
        group_id=group_id,
        material_type='deck',
        material_id=deck_id,
        owner_id=owner_id,
        created_at=datetime.utcnow()
    )

    await db.add(group_material)
    await db.commit()

    # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    await notify_group_members(
        group_id,
        f"–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª: {deck.name}"
    )
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∫–æ–ª–æ–¥:**
```python
async def get_decks_with_group(
    profile_id: str,
    include_group: bool = True
) -> list[Deck]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–æ–¥—ã –ø—Ä–æ—Ñ–∏–ª—è, –≤–∫–ª—é—á–∞—è –≥—Ä—É–ø–ø–æ–≤—ã–µ.
    """
    # 1. –õ–∏—á–Ω—ã–µ –∫–æ–ª–æ–¥—ã
    own_decks = await db.query(Deck).filter(
        Deck.profile_id == profile_id,
        Deck.deleted == False
    ).all()

    if not include_group:
        return own_decks

    # 2. –ì—Ä—É–ø–ø–æ–≤—ã–µ –∫–æ–ª–æ–¥—ã
    user = await get_user_by_profile(profile_id)

    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–≤—É–µ—Ç
    user_groups = await db.query(GroupMember).filter(
        GroupMember.user_id == user.id
    ).all()

    group_decks = []

    for membership in user_groups:
        # –ü–æ–ª—É—á–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã
        materials = await db.query(GroupMaterial).filter(
            GroupMaterial.group_id == membership.group_id,
            GroupMaterial.material_type == 'deck'
        ).all()

        for material in materials:
            deck = await db.query(Deck).filter(
                Deck.id == material.material_id
            ).first()

            if deck and not deck.deleted:
                # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≥—Ä—É–ø–ø–æ–≤—É—é
                deck.is_group = True
                deck.owner_id = material.owner_id
                deck.owner_name = await get_user_name(material.owner_id)
                group_decks.append(deck)

    return own_decks + group_decks
```

#### –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≥—Ä—É–ø–ø–æ–≤—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º

**–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å:**
- –ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º
- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, –æ—Ü–µ–Ω–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
- –í–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```python
# –¢–∞–±–ª–∏—Ü–∞ card_reviews —Ö—Ä–∞–Ω–∏—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
class CardReview:
    id: UUID
    card_id: UUID  # –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–π –∫–æ–ª–æ–¥—ã
    user_id: UUID  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
    profile_id: UUID  # –ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
    rating: str  # 'know', 'repeat', 'dont_know'
    interval_before: int
    interval_after: int
    created_at: datetime
```

**–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞):**
```python
async def get_member_progress(
    group_id: str,
    user_id: str,
    owner_id: str
) -> MemberProgress:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –≥—Ä—É–ø–ø—ã.

    –¢–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≥—Ä—É–ø–ø—ã.
    """
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    group = await db.query(Group).filter(Group.id == group_id).first()

    if group.owner_id != owner_id:
        raise PermissionError("–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å")

    # 2. –ü–æ–ª—É—á–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã (–∫–æ–ª–æ–¥—ã)
    materials = await db.query(GroupMaterial).filter(
        GroupMaterial.group_id == group_id,
        GroupMaterial.material_type == 'deck'
    ).all()

    decks_progress = []

    for material in materials:
        deck = await db.query(Deck).filter(
            Deck.id == material.material_id
        ).first()

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–ª–æ–¥—ã
        cards = await db.query(Card).filter(
            Card.deck_id == deck.id,
            Card.deleted == False
        ).all()

        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ —ç—Ç–∏–º –∫–∞—Ä—Ç–æ—á–∫–∞–º
        reviews = await db.query(CardReview).filter(
            CardReview.card_id.in_([c.id for c in cards]),
            CardReview.user_id == user_id
        ).all()

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        total_cards = len(cards)
        studied_cards = len(set(r.card_id for r in reviews))

        stats = {
            'know': sum(1 for r in reviews if r.rating == 'know'),
            'repeat': sum(1 for r in reviews if r.rating == 'repeat'),
            'dont_know': sum(1 for r in reviews if r.rating == 'dont_know')
        }

        decks_progress.append({
            'deck_id': deck.id,
            'deck_name': deck.name,
            'total_cards': total_cards,
            'studied_cards': studied_cards,
            'progress': studied_cards / total_cards if total_cards > 0 else 0,
            'stats': stats,
            'last_activity': max((r.created_at for r in reviews), default=None)
        })

    return MemberProgress(
        user_id=user_id,
        user_name=await get_user_name(user_id),
        decks=decks_progress
    )
```

**API Endpoint:**
```
GET /api/groups/{group_id}/members/{user_id}/progress
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –í–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å

## –ü—Ä–æ—Ü–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è

### –†–µ–∂–∏–º—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

#### 1. –ß–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

**–ö–æ–º–∞–Ω–¥–∞ `/study`:**
```python
async def study_command(update: Update, context: CallbackContext):
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –±–æ—Ç–µ.
    """
    user = await get_user(update.effective_user.id)
    profile = await get_active_profile(user.id)
    active_deck = await get_active_deck(profile.id)

    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    card = await get_next_card(active_deck.id)

    if not card:
        await update.message.reply_text(
            "üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!\n\n"
            "–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è.\n"
            "–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!"
        )
        return

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    await show_card(update, card, side='front')
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:**
```python
async def show_card(
    update: Update,
    card: Card,
    side: Literal['front', 'back']
):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    Side:
    - 'front': –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–≤–æ –Ω–∞ –∏–∑—É—á–∞–µ–º–æ–º —è–∑—ã–∫–µ
    - 'back': –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø—Ä–∏–º–µ—Ä
    """
    if side == 'front':
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–≤–æ
        message = f"üá™üá∏ {card.word}\n\n"
        message += f"üìñ {card.example}"

        # –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥"
        keyboard = [[
            InlineKeyboardButton(
                text="–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥",
                callback_data=f"show_back:{card.id}"
            )
        ]]

        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            message,
            reply_markup=reply_markup
        )

    else:  # 'back'
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø—Ä–∏–º–µ—Ä
        message = f"üá™üá∏ {card.word}\n"
        message += f"üá∑üá∫ {card.translation}\n\n"
        message += f"üìñ {card.example}\n"
        message += f"   {card.example_translation}\n\n"

        if card.notes:
            message += f"üí° {card.notes}\n\n"

        message += "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –≤—ã –ø–æ–º–Ω–∏—Ç–µ —ç—Ç–æ —Å–ª–æ–≤–æ?"

        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏
        keyboard = [
            [
                InlineKeyboardButton("‚ùå –ù–µ –∑–Ω–∞—é", callback_data=f"rate:{card.id}:dont_know"),
                InlineKeyboardButton("üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å", callback_data=f"rate:{card.id}:repeat"),
                InlineKeyboardButton("‚úÖ –ó–Ω–∞—é", callback_data=f"rate:{card.id}:know")
            ]
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.callback_query.edit_message_text(
            message,
            reply_markup=reply_markup
        )
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ü–µ–Ω–∫–∏:**
```python
async def handle_rating(
    update: Update,
    context: CallbackContext
):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    """
    # –ü–∞—Ä—Å–∏–º callback_data: "rate:<card_id>:<rating>"
    data = update.callback_query.data.split(':')
    card_id = data[1]
    rating = data[2]  # 'know', 'repeat', 'dont_know'

    user = await get_user(update.effective_user.id)
    profile = await get_active_profile(user.id)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    updated_card = await rate_card(
        card_id=card_id,
        user_id=user.id,
        profile_id=profile.id,
        rating=rating
    )

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if rating == 'know':
        emoji = '‚úÖ'
        text = '–û—Ç–ª–∏—á–Ω–æ!'
        next_review_text = f"–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {updated_card.interval_days} –¥–Ω."
    elif rating == 'repeat':
        emoji = 'üîÅ'
        text = '–•–æ—Ä–æ—à–æ, –ø–æ–≤—Ç–æ—Ä–∏–º –µ—â–µ —Ä–∞–∑'
        next_review_text = '–ü–æ–∫–∞–∂–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç'
    else:  # dont_know
        emoji = '‚ùå'
        text = '–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ! –ü–æ–≤—Ç–æ—Ä–∏–º –∑–∞–≤—Ç—Ä–∞'
        next_review_text = '–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞'

    await update.callback_query.answer(f"{emoji} {text}")

    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    active_deck = await get_active_deck(profile.id)
    next_card = await get_next_card(active_deck.id)

    if next_card:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        await show_card(update, next_card, side='front')
    else:
        # –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        stats = await get_session_stats(user.id, profile.id)

        message = (
            f"üéâ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
            f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"‚úÖ –ó–Ω–∞—é: {stats['know']}\n"
            f"üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å: {stats['repeat']}\n"
            f"‚ùå –ù–µ –∑–Ω–∞—é: {stats['dont_know']}\n\n"
            f"{next_review_text}"
        )

        await update.callback_query.edit_message_text(message)
```

#### 2. –ß–µ—Ä–µ–∑ Mini App

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑—É—á–µ–Ω–∏—è:**

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏:**
```tsx
// components/FlashcardView.tsx
const FlashcardView: React.FC<{ card: Card }> = ({ card }) => {
  const [flipped, setFlipped] = useState(false);

  const handleFlip = () => {
    setFlipped(!flipped);
  };

  const handleRate = async (rating: 'know' | 'repeat' | 'dont_know') => {
    await api.cards.rate(card.id, rating);

    // –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    const nextCard = await api.cards.getNext(deckId);

    if (nextCard) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é
      setCard(nextCard);
      setFlipped(false);
    } else {
      // –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
      showSessionComplete();
    }
  };

  return (
    <div className="flashcard-container">
      <div
        className={`flashcard ${flipped ? 'flipped' : ''}`}
        onClick={handleFlip}
      >
        {!flipped ? (
          // –õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
          <div className="front">
            <h2 className="word">{card.word}</h2>
            <p className="example">{card.example}</p>
            <p className="hint">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–≤–æ–¥</p>
          </div>
        ) : (
          // –û–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
          <div className="back">
            <h2 className="word">{card.word}</h2>
            <h3 className="translation">{card.translation}</h3>
            <div className="example-block">
              <p className="example">{card.example}</p>
              <p className="example-translation">{card.example_translation}</p>
            </div>
            {card.notes && (
              <p className="notes">üí° {card.notes}</p>
            )}
          </div>
        )}
      </div>

      {flipped && (
        <div className="rating-buttons">
          <button
            className="btn-dont-know"
            onClick={() => handleRate('dont_know')}
          >
            ‚ùå –ù–µ –∑–Ω–∞—é
          </button>
          <button
            className="btn-repeat"
            onClick={() => handleRate('repeat')}
          >
            üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
          </button>
          <button
            className="btn-know"
            onClick={() => handleRate('know')}
          >
            ‚úÖ –ó–Ω–∞—é
          </button>
        </div>
      )}
    </div>
  );
};
```

**–°–µ—Å—Å–∏—è –∏–∑—É—á–µ–Ω–∏—è:**
```tsx
// screens/StudySession.tsx
const StudySession: React.FC = () => {
  const [deck, setDeck] = useState<Deck | null>(null);
  const [card, setCard] = useState<Card | null>(null);
  const [sessionStats, setSessionStats] = useState({
    know: 0,
    repeat: 0,
    dont_know: 0,
    total: 0
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadNextCard();
  }, []);

  const loadNextCard = async () => {
    setLoading(true);

    try {
      const nextCard = await api.cards.getNext(deckId);

      if (nextCard) {
        setCard(nextCard);
      } else {
        // –ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
        showSessionComplete();
      }
    } catch (error) {
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É');
    } finally {
      setLoading(false);
    }
  };

  const handleRate = (rating: CardRating) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    setSessionStats(prev => ({
      ...prev,
      [rating]: prev[rating] + 1,
      total: prev.total + 1
    }));

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    loadNextCard();
  };

  if (loading) {
    return <LoadingSpinner />;
  }

  if (!card) {
    return (
      <SessionComplete
        stats={sessionStats}
        onRestart={() => loadNextCard()}
      />
    );
  }

  return (
    <div className="study-session">
      <SessionHeader deck={deck} stats={sessionStats} />
      <FlashcardView card={card} onRate={handleRate} />
      <SessionProgress deck={deck} />
    </div>
  );
};
```

#### 3. –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (Quick Review)

**–í –±–æ—Ç–µ:**
```
/quick_review - –±—ã—Å—Ç—Ä–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å 10 –∫–∞—Ä—Ç–æ—á–µ–∫
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
- –ú–∞–∫—Å–∏–º—É–º 10 –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞ —Å–µ—Å—Å–∏—é
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤

**–í Mini App:**
- –ö–Ω–æ–ø–∫–∞ "–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ" –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–∞—Ä—Ç–æ—á–µ–∫
- –ú–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

#### 4. –†–µ–∂–∏–º "–£—á—É –Ω–æ–≤—ã–µ" (Learn New)

**–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫:**
```python
async def learn_new_cards(deck_id: str, limit: int = 10) -> list[Card]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.

    –õ–∏–º–∏—Ç: 10 –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞ —Å–µ—Å—Å–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    """
    return await db.query(Card).filter(
        Card.deck_id == deck_id,
        Card.status == 'new',
        Card.deleted == False
    ).order_by(
        Card.created_at.asc()  # –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ
    ).limit(limit).all()
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —Ö–æ—á–µ—Ç –≤—ã—É—á–∏—Ç—å
- –ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- –ü–æ—Å–ª–µ –æ—Ü–µ–Ω–∫–∏ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å `learning`

### –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫

**–ù–∞ —É—Ä–æ–≤–Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∏:**
```python
class Card:
    # ... –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    status: str  # 'new', 'learning', 'review'
    interval_days: int  # –¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    next_review: datetime  # –°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
    reviews_count: int  # –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–≤—Ç–æ—Ä—è–ª–∞—Å—å
    last_rating: str | None  # –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
```

**–ù–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–ª–æ–¥—ã:**
```python
class Deck:
    # ... –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    cards_count: int  # –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫
    new_cards_count: int  # –ù–æ–≤—ã—Ö
    due_cards_count: int  # –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è
```

**–í—ã—á–∏—Å–ª—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```python
async def get_deck_stats(deck_id: str) -> DeckStats:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–ª–æ–¥—ã.
    """
    cards = await db.query(Card).filter(
        Card.deck_id == deck_id,
        Card.deleted == False
    ).all()

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    new_count = sum(1 for c in cards if c.status == 'new')
    learning_count = sum(1 for c in cards if c.status == 'learning')
    review_count = sum(1 for c in cards if c.status == 'review')

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ (due)
    now = datetime.utcnow()
    due_count = sum(1 for c in cards if c.next_review <= now and c.status != 'new')

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–µ
    know_count = sum(1 for c in cards if c.last_rating == 'know')
    repeat_count = sum(1 for c in cards if c.last_rating == 'repeat')
    dont_know_count = sum(1 for c in cards if c.last_rating == 'dont_know')

    return DeckStats(
        total=len(cards),
        new=new_count,
        learning=learning_count,
        review=review_count,
        due=due_count,
        know=know_count,
        repeat=repeat_count,
        dont_know=dont_know_count
    )
```

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Streak (—Å–µ—Ä–∏—è –¥–Ω–µ–π):**
```python
async def calculate_streak(user_id: str, profile_id: str) -> StreakInfo:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç streak (—Å–µ—Ä–∏—é –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥).

    –£—Å–ª–æ–≤–∏–µ streak: —Ö–æ—Ç—è –±—ã 1 –¥–µ–π—Å—Ç–≤–∏–µ –≤ –¥–µ–Ω—å
    –î–µ–π—Å—Ç–≤–∏—è: –∏–∑—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, —Å–æ–æ–±—â–µ–Ω–∏–µ LLM
    """
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    activity_dates = await db.query(
        func.date(Activity.created_at).label('date')
    ).filter(
        Activity.user_id == user_id,
        Activity.profile_id == profile_id
    ).distinct().order_by(
        func.date(Activity.created_at).desc()
    ).all()

    if not activity_dates:
        return StreakInfo(current=0, best=0, total_days=0)

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π streak
    current_streak = 0
    today = datetime.utcnow().date()
    expected_date = today

    for activity_date in activity_dates:
        date = activity_date.date

        if date == expected_date:
            current_streak += 1
            expected_date = expected_date - timedelta(days=1)
        elif date < expected_date:
            # –ü—Ä–æ–ø—É—Å–∫ –¥–Ω—è - streak –ø—Ä–µ—Ä–≤–∞–Ω
            break

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª—É—á—à–∏–π streak (—Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏)
    best_streak = await calculate_best_streak(activity_dates)

    return StreakInfo(
        current=current_streak,
        best=best_streak,
        total_days=len(activity_dates)
    )
```

**–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—é:**
```python
async def get_level_progress(profile_id: str) -> LevelProgress:
    """
    –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é.

    –ö—Ä–∏—Ç–µ—Ä–∏–∏:
    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Å—Ç–∞—Ç—É—Å–µ 'review'
    - –¢–æ—á–Ω–æ—Å—Ç—å –≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö
    - –í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è
    """
    profile = await db.query(LanguageProfile).filter(
        LanguageProfile.id == profile_id
    ).first()

    # –ö–∞—Ä—Ç–æ—á–∫–∏
    cards_stats = await get_profile_cards_stats(profile_id)

    # –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    exercises_stats = await get_profile_exercises_stats(profile_id)

    # –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å:
    # A1 ‚Üí A2: 300 –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ review + 80% accuracy
    # A2 ‚Üí B1: 600 –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ review + 85% accuracy
    # B1 ‚Üí B2: 1000 –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ review + 90% accuracy

    target_cards = {
        'A1': 300,
        'A2': 600,
        'B1': 1000,
        'B2': 1500,
        'C1': 2000
    }.get(profile.current_level, 2500)

    target_accuracy = {
        'A1': 0.80,
        'A2': 0.85,
        'B1': 0.90,
        'B2': 0.92,
        'C1': 0.95
    }.get(profile.current_level, 0.95)

    # –ü—Ä–æ–≥—Ä–µ—Å—Å
    cards_progress = min(cards_stats.review_count / target_cards, 1.0)
    accuracy_progress = min(exercises_stats.accuracy / target_accuracy, 1.0)

    # –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ)
    overall_progress = 0.6 * cards_progress + 0.4 * accuracy_progress

    return LevelProgress(
        current_level=profile.current_level,
        target_level=profile.target_level,
        progress=overall_progress,
        cards_mastered=cards_stats.review_count,
        target_cards=target_cards,
        exercises_accuracy=exercises_stats.accuracy,
        target_accuracy=target_accuracy
    )
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥:**
```python
async def get_user_stats(
    user_id: str,
    profile_id: str,
    period: Literal['week', 'month', '3months', 'year', 'all'] = 'month'
) -> UserStats:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
    now = datetime.utcnow()
    start_date = {
        'week': now - timedelta(days=7),
        'month': now - timedelta(days=30),
        '3months': now - timedelta(days=90),
        'year': now - timedelta(days=365),
        'all': datetime(1970, 1, 1)
    }[period]

    # –ö–∞—Ä—Ç–æ—á–∫–∏
    cards_reviews = await db.query(CardReview).filter(
        CardReview.user_id == user_id,
        CardReview.profile_id == profile_id,
        CardReview.created_at >= start_date
    ).all()

    # –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    exercises = await db.query(ExerciseAttempt).filter(
        ExerciseAttempt.user_id == user_id,
        ExerciseAttempt.profile_id == profile_id,
        ExerciseAttempt.created_at >= start_date
    ).all()

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º
    cards_stats = {
        'know': sum(1 for r in cards_reviews if r.rating == 'know'),
        'repeat': sum(1 for r in cards_reviews if r.rating == 'repeat'),
        'dont_know': sum(1 for r in cards_reviews if r.rating == 'dont_know')
    }

    exercises_stats = {
        'correct': sum(1 for e in exercises if e.result == 'correct'),
        'partial': sum(1 for e in exercises if e.result == 'partial'),
        'incorrect': sum(1 for e in exercises if e.result == 'incorrect')
    }

    accuracy = (
        exercises_stats['correct'] / len(exercises)
        if exercises else 0
    )

    # –í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è
    time_minutes = sum(
        (e.duration_seconds or 0) / 60
        for e in exercises
    )

    # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º
    activity_by_day = await get_activity_calendar(
        user_id, profile_id, start_date, now
    )

    # Streak
    streak = await calculate_streak(user_id, profile_id)

    return UserStats(
        profile_id=profile_id,
        period=period,
        streak=streak,
        cards=CardStats(
            total=len(cards_reviews),
            stats=cards_stats
        ),
        exercises=ExerciseStats(
            total=len(exercises),
            stats=exercises_stats,
            accuracy=accuracy
        ),
        time=TimeStats(
            total_minutes=int(time_minutes),
            average_per_day=int(time_minutes / max(streak.total_days, 1))
        ),
        activity=activity_by_day
    )
```

**API Endpoints:**
```
GET /api/stats?profile_id=<uuid>&period=month
GET /api/stats/streak?profile_id=<uuid>
GET /api/stats/calendar?profile_id=<uuid>&weeks=12
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ Mini App:**
- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å)
- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –æ—Ü–µ–Ω–∫–∞–º (know/repeat/dont_know)
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- –°—á–µ—Ç—á–∏–∫ streak
- –¢–æ–ø-5 —Å–∞–º—ã—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö –∫–æ–ª–æ–¥

---

–î–æ–∫—É–º–µ–Ω—Ç backend-flashcards.md —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —è–∑—ã–∫–æ–≤.
